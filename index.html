<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Alike ‚Äì Find out what you have in common</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #F5F0E8;
    --card: #FFFDF8;
    --ink: #1A1410;
    --muted: #8A8076;
    --match: #2ECC7A;
    --nomatch: #E84040;
    --skip: #B0A89C;
    --accent: #FF6B35;
    --accent2: #FFD166;
    --left-glow: rgba(255,107,53,0.15);
    --right-glow: rgba(46,204,122,0.15);
    --radius: 24px;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow: hidden;
    position: relative;
  }

  /* Decorative blobs */
  body::before {
    content: '';
    position: fixed;
    top: -120px; right: -80px;
    width: 380px; height: 380px;
    background: radial-gradient(circle, rgba(255,209,102,0.35) 0%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
  }
  body::after {
    content: '';
    position: fixed;
    bottom: -100px; left: -60px;
    width: 300px; height: 300px;
    background: radial-gradient(circle, rgba(255,107,53,0.2) 0%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
  .screen {
    position: fixed; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 24px;
    z-index: 1;
    transition: opacity 0.4s, transform 0.4s;
  }
  .screen.hidden {
    opacity: 0; pointer-events: none; transform: scale(0.97);
  }

  /* ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ */
  #screen-welcome { gap: 0; }

  .logo-mark {
    width: 72px; height: 72px;
    background: var(--ink);
    border-radius: 20px;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 28px;
    position: relative;
    box-shadow: none;
  }
  .logo-mark svg { width: 40px; height: 40px; }

  h1 {
    font-family: 'Syne', sans-serif;
    font-size: clamp(42px, 10vw, 64px);
    font-weight: 800;
    color: var(--ink);
    letter-spacing: -2px;
    line-height: 1;
    margin-bottom: 12px;
  }
  .tagline {
    font-size: 15px;
    color: var(--muted);
    letter-spacing: 0.5px;
    margin-bottom: 48px;
    max-width: 260px;
    text-align: center;
    line-height: 1.6;
  }

  /* Category chips */
  .categories {
    display: flex; flex-wrap: wrap; gap: 8px;
    justify-content: center;
    max-width: 340px;
    margin-bottom: 40px;
  }
  .cat-chip {
    padding: 10px 18px;
    border-radius: 100px;
    border: 1.5px solid var(--ink);
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    background: var(--card);
    color: var(--ink);
    transition: all 0.18s;
    user-select: none;
  }
  .cat-chip:hover, .cat-chip.active {
    background: var(--ink);
    color: var(--bg);
    transform: translateY(-2px);
  }
  .cat-chip.active {
  }

  .btn-primary {
    padding: 16px 40px;
    background: var(--ink);
    color: var(--bg);
    border: none;
    border-radius: 100px;
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.5px;
    transition: all 0.18s;
  }
  .btn-primary:hover { transform: translate(-1px,-1px); }
  .btn-primary:active { transform: translate(1px,1px); }

  /* ‚îÄ‚îÄ QUIZ SCREEN ‚îÄ‚îÄ */
  #screen-quiz {
    justify-content: flex-start;
    padding-top: 0;
    gap: 0;
  }

  .quiz-header {
    width: 100%; max-width: 420px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 4px 0;
    margin-bottom: 16px;
  }
  .quiz-cat {
    font-family: 'Syne', sans-serif;
    font-size: 13px; font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--muted);
  }
  .quiz-counter {
    font-family: 'Syne', sans-serif;
    font-size: 13px; font-weight: 700;
    color: var(--ink);
    background: var(--card);
    border: 1.5px solid var(--ink);
    padding: 4px 12px;
    border-radius: 100px;
  }

  /* Progress bar */
  .progress-bar {
    width: 100%; max-width: 420px;
    height: 4px;
    background: rgba(26,20,16,0.12);
    border-radius: 100px;
    margin-bottom: 24px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: var(--ink);
    border-radius: 100px;
    transition: width 0.4s cubic-bezier(0.4,0,0.2,1);
  }

  /* Card */
  .card-stage {
    width: 100%; max-width: 420px;
    position: relative;
    height: 340px;
    perspective: 1000px;
  }

  .question-card {
    position: absolute; inset: 0;
    background: var(--card);
    border-radius: var(--radius);
    border: 2px solid var(--ink);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 32px 24px;
    box-shadow: 6px 6px 0 var(--ink);
    cursor: grab;
    user-select: none;
    transition: box-shadow 0.2s;
    will-change: transform;
  }
  .question-card:active { cursor: grabbing; }

  .card-label {
    font-size: 13px;
    font-weight: 500;
    color: var(--ink);
    margin-bottom: 24px;
    opacity: 0.65;
    text-align: center;
    max-width: 320px;
    line-height: 1.5;
    letter-spacing: 0;
  }

  .options-row {
    display: flex; align-items: center;
    gap: 16px;
    width: 100%;
  }

  /* Clickable options - now interactive */
  .opt {
    flex: 1;
    text-align: center;
    padding: 20px 12px;
    border-radius: 16px;
    border: 2px solid rgba(26,20,16,0.12);
    transition: all 0.18s cubic-bezier(0.34,1.56,0.64,1);
    position: relative;
    overflow: hidden;
    cursor: pointer;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  .opt:hover {
    border-color: rgba(26,20,16,0.3);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(26,20,16,0.08);
  }
  .opt:active, .opt.pressing {
    transform: scale(0.96);
  }
  .opt.chosen-left {
    background: rgba(46,204,122,0.15);
    border-color: var(--match);
    transform: scale(1.04);
  }
  .opt.chosen-right {
    background: rgba(46,204,122,0.15);
    border-color: var(--match);
    transform: scale(1.04);
  }

  .opt-text {
    font-family: 'Syne', sans-serif;
    font-size: clamp(12px, 3.5vw, 18px);
    font-weight: 700;
    color: var(--ink);
    line-height: 1.2;
    word-break: normal;
    overflow-wrap: break-word;
    hyphens: auto;
  }

  .or-badge {
    width: 36px; height: 36px;
    background: var(--ink);
    color: var(--bg);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif;
    font-size: 11px; font-weight: 800;
    letter-spacing: 0.5px;
    flex-shrink: 0;
  }

  /* Swipe hint labels on card */
  .swipe-hint {
    position: absolute;
    top: 20px;
    font-family: 'Syne', sans-serif;
    font-size: 13px; font-weight: 800;
    letter-spacing: 1px;
    text-transform: uppercase;
    opacity: 0;
    transition: opacity 0.1s;
    padding: 6px 14px;
    border-radius: 8px;
    border: 2px solid;
  }
  .swipe-hint.left { left: 16px; color: var(--accent); border-color: var(--accent); background: rgba(255,107,53,0.08); }
  .swipe-hint.right { right: 16px; color: var(--match); border-color: var(--match); background: rgba(46,204,122,0.08); }
  .swipe-hint.up { top: 16px; left: 50%; transform: translateX(-50%); color: var(--muted); border-color: var(--muted); white-space: nowrap; background: rgba(176,168,156,0.1); }

  /* ‚îÄ‚îÄ BOTTOM ACTION BAR ‚îÄ‚îÄ */
  .action-bar {
    display: flex;
    gap: 28px;
    margin-top: 28px;
    align-items: flex-start;
    justify-content: center;
  }
  .action-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .action-circle {
    width: 60px; height: 60px;
    border-radius: 50%;
    border: 2.5px solid var(--ink);
    background: var(--card);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    transition: all 0.18s cubic-bezier(0.34,1.56,0.64,1);
    box-shadow: 3px 3px 0 var(--ink);
    user-select: none;
  }
  .action-circle:hover { transform: translate(-1px,-2px); box-shadow: 4px 5px 0 var(--ink); }
  .action-circle:active { transform: translate(1px,1px); box-shadow: 1px 1px 0 var(--ink); }
  .action-circle.liked {
    background: var(--accent2);
    border-color: var(--ink);
    animation: pop 0.3s cubic-bezier(0.34,1.56,0.64,1);
  }
  @keyframes pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.25); }
    100% { transform: scale(1); }
  }
  .action-label {
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: 0.3px;
    text-align: center;
  }
  .action-item.skip-btn .action-circle {
    font-size: 18px;
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    color: var(--ink);
  }

  /* ‚îÄ‚îÄ BURGER MENU ‚îÄ‚îÄ */
  .burger-btn {
    position: fixed;
    top: 16px; right: 16px;
    width: 44px; height: 44px;
    border-radius: 12px;
    background: var(--ink);
    border: none;
    cursor: pointer;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 5px;
    z-index: 200;
    transition: all 0.18s;
    -webkit-tap-highlight-color: transparent;
  }
  .burger-btn:hover { transform: translate(-1px,-1px); }
  .burger-btn span {
    display: block;
    width: 18px; height: 2px;
    background: var(--bg);
    border-radius: 2px;
    transition: all 0.3s;
  }
  .burger-btn.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
  .burger-btn.open span:nth-child(2) { opacity: 0; transform: scaleX(0); }
  .burger-btn.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

  /* Drawer overlay */
  .drawer-overlay {
    position: fixed; inset: 0;
    background: rgba(26,20,16,0.4);
    z-index: 190;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    backdrop-filter: blur(2px);
  }
  .drawer-overlay.open { opacity: 1; pointer-events: all; }

  /* Drawer panel */
  .drawer {
    position: fixed;
    top: 0; right: 0; bottom: 0;
    width: min(300px, 85vw);
    background: var(--card);
    border-left: 2px solid var(--ink);
    z-index: 195;
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
    display: flex; flex-direction: column;
    padding: 0;
    box-shadow: -8px 0 40px rgba(26,20,16,0.15);
  }
  .drawer.open { transform: translateX(0); }

  .drawer-header {
    padding: 20px 24px 16px;
    border-bottom: 1.5px solid rgba(26,20,16,0.08);
    display: flex; align-items: center; gap: 12px;
  }
  .drawer-logo {
    width: 36px; height: 36px;
    background: var(--ink); border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 3px 3px 0 var(--accent);
  }
  .drawer-logo svg { width: 20px; height: 20px; }
  .drawer-title {
    font-family: 'Syne', sans-serif;
    font-size: 20px; font-weight: 800;
    color: var(--ink); letter-spacing: -0.5px;
  }

  .drawer-nav {
    flex: 1; padding: 16px 0;
    overflow-y: auto;
  }
  .drawer-item {
    display: flex; align-items: center; gap: 16px;
    padding: 14px 24px;
    cursor: pointer;
    transition: background 0.15s;
    border-radius: 0;
    -webkit-tap-highlight-color: transparent;
  }
  .drawer-item:hover { background: rgba(26,20,16,0.04); }
  .drawer-item.active { background: rgba(255,107,53,0.08); }
  .drawer-icon {
    width: 40px; height: 40px;
    border-radius: 12px;
    background: var(--bg);
    border: 1.5px solid rgba(26,20,16,0.12);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }
  .drawer-item-text { flex: 1; }
  .drawer-item-label {
    font-family: 'Syne', sans-serif;
    font-size: 15px; font-weight: 700;
    color: var(--ink);
  }
  .drawer-item-sub {
    font-size: 12px; color: var(--muted);
    margin-top: 1px;
  }
  .drawer-badge {
    background: var(--accent);
    color: white;
    font-family: 'Syne', sans-serif;
    font-size: 11px; font-weight: 700;
    padding: 2px 8px;
    border-radius: 100px;
    min-width: 20px;
    text-align: center;
  }

  .drawer-section-title {
    padding: 12px 24px 4px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
  }

  .drawer-footer {
    padding: 16px 24px;
    border-top: 1.5px solid rgba(26,20,16,0.08);
    font-size: 11px;
    color: var(--muted);
    text-align: center;
  }

  /* ‚îÄ‚îÄ MENU SCREENS (Matches, Messages, Settings) ‚îÄ‚îÄ */
  .panel-screen {
    position: fixed; inset: 0;
    background: var(--bg);
    z-index: 180;
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
    display: flex; flex-direction: column;
    overflow: hidden;
  }
  .panel-screen.open { transform: translateX(0); }

  .panel-header {
    display: flex; align-items: center; gap: 12px;
    padding: 56px 20px 16px;
    border-bottom: 1.5px solid rgba(26,20,16,0.1);
    background: var(--card);
  }
  .panel-back {
    width: 36px; height: 36px;
    border-radius: 10px;
    border: 2px solid var(--ink);
    background: transparent;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.15s;
  }
  .panel-back:hover { background: var(--ink); color: var(--bg); }
  .panel-title {
    font-family: 'Syne', sans-serif;
    font-size: 22px; font-weight: 800;
    color: var(--ink); letter-spacing: -0.5px;
  }
  .panel-body {
    flex: 1; overflow-y: auto;
    padding: 20px;
  }

  /* Match list items */
  .match-list-item {
    background: var(--card);
    border: 2px solid var(--ink);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 3px 3px 0 var(--ink);
    display: flex; gap: 14px; align-items: center;
    cursor: pointer;
    transition: all 0.15s;
  }
  .match-list-item:hover { transform: translate(-1px,-1px); box-shadow: 4px 4px 0 var(--ink); }
  .match-cat-icon {
    width: 48px; height: 48px;
    border-radius: 12px;
    background: var(--bg);
    border: 1.5px solid rgba(26,20,16,0.12);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    flex-shrink: 0;
  }
  .match-info { flex: 1; }
  .match-info-title {
    font-family: 'Syne', sans-serif;
    font-size: 15px; font-weight: 700;
    color: var(--ink);
  }
  .match-info-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .match-pct-badge {
    font-family: 'Syne', sans-serif;
    font-size: 16px; font-weight: 800;
    color: var(--ink);
  }

  /* Messages */
  .msg-list-item {
    background: var(--card);
    border: 2px solid var(--ink);
    border-radius: 16px;
    padding: 14px 16px;
    margin-bottom: 10px;
    display: flex; gap: 12px; align-items: center;
    cursor: pointer;
    transition: all 0.15s;
    box-shadow: 3px 3px 0 var(--ink);
  }
  .msg-list-item:hover { transform: translate(-1px,-1px); box-shadow: 4px 4px 0 var(--ink); }
  .msg-avatar {
    width: 44px; height: 44px;
    border-radius: 50%;
    background: var(--accent2);
    border: 2px solid var(--ink);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }
  .msg-info { flex: 1; min-width: 0; }
  .msg-name {
    font-family: 'Syne', sans-serif;
    font-size: 14px; font-weight: 700;
    color: var(--ink);
  }
  .msg-preview {
    font-size: 12px; color: var(--muted);
    margin-top: 2px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .msg-time { font-size: 11px; color: var(--muted); flex-shrink: 0; }
  .msg-unread {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent);
    flex-shrink: 0;
    align-self: center;
  }

  /* Chat view */
  .chat-header {
    display: flex; align-items: center; gap: 12px;
    padding: 56px 20px 16px;
    border-bottom: 1.5px solid rgba(26,20,16,0.1);
    background: var(--card);
  }
  .chat-messages {
    flex: 1; overflow-y: auto;
    padding: 16px 20px;
    display: flex; flex-direction: column; gap: 10px;
  }
  .chat-bubble {
    max-width: 72%;
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.4;
    word-break: break-word;
  }
  .chat-bubble.me {
    background: var(--ink);
    color: var(--bg);
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }
  .chat-bubble.them {
    background: var(--card);
    border: 1.5px solid rgba(26,20,16,0.12);
    color: var(--ink);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }
  .chat-input-bar {
    padding: 12px 16px;
    border-top: 1.5px solid rgba(26,20,16,0.1);
    background: var(--card);
    display: flex; gap: 10px; align-items: center;
  }
  .chat-input {
    flex: 1;
    padding: 10px 14px;
    border-radius: 100px;
    border: 1.5px solid rgba(26,20,16,0.2);
    background: var(--bg);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    outline: none;
  }
  .chat-input:focus { border-color: var(--ink); }
  .edit-q-item {
    background: var(--card);
    border: 1.5px solid rgba(26,20,16,0.12);
    border-radius: 14px;
    padding: 10px 12px;
    display: flex; flex-direction: column; gap: 6px;
  }
  .edit-q-input {
    width: 100%; padding: 7px 10px;
    border: 1.5px solid rgba(26,20,16,0.15);
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif; font-size: 13px;
    background: var(--bg); color: var(--ink);
    outline: none; box-sizing: border-box;
  }
  .edit-q-input:focus { border-color: var(--ink); }
  .edit-q-row { display: flex; gap: 6px; align-items: center; }
  .edit-q-label { font-size: 10px; font-weight: 700; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; width: 14px; flex-shrink:0; }
  .edit-q-save {
    margin-top: 4px; padding: 6px 14px;
    background: var(--ink); color: var(--bg);
    border: none; border-radius: 100px;
    font-family: 'Syne', sans-serif; font-size: 11px; font-weight: 700;
    cursor: pointer; align-self: flex-end;
  }

  .chat-send {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: var(--ink);
    border: none;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .chat-send:hover { background: #333; }

  /* Settings */
  .settings-section {
    background: var(--card);
    border: 2px solid var(--ink);
    border-radius: 16px;
    margin-bottom: 16px;
    overflow: hidden;
    box-shadow: 3px 3px 0 var(--ink);
  }
  .settings-item {
    display: flex; align-items: center; gap: 14px;
    padding: 14px 16px;
    border-bottom: 1px solid rgba(26,20,16,0.06);
    cursor: pointer;
    transition: background 0.15s;
  }
  .settings-item:last-child { border-bottom: none; }
  .settings-item:hover { background: rgba(26,20,16,0.03); }
  .settings-item-icon { font-size: 20px; }
  .settings-item-label {
    flex: 1;
    font-family: 'Syne', sans-serif;
    font-size: 14px; font-weight: 600;
    color: var(--ink);
  }
  .settings-item-value {
    font-size: 13px; color: var(--muted);
  }
  .settings-toggle {
    width: 40px; height: 22px;
    border-radius: 100px;
    background: rgba(26,20,16,0.15);
    border: none;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
  }
  .settings-toggle.on { background: var(--match); }
  .settings-toggle::after {
    content: '';
    position: absolute;
    top: 3px; left: 3px;
    width: 16px; height: 16px;
    border-radius: 50%;
    background: white;
    transition: transform 0.2s;
  }
  .settings-toggle.on::after { transform: translateX(18px); }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
  }
  .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
  .empty-state-title {
    font-family: 'Syne', sans-serif;
    font-size: 20px; font-weight: 800;
    color: var(--ink); margin-bottom: 8px;
  }
  .empty-state-sub { font-size: 14px; color: var(--muted); line-height: 1.6; }

  /* New question modal */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(26,20,16,0.5);
    z-index: 300;
    display: flex; align-items: flex-end; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
    backdrop-filter: blur(3px);
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal-sheet {
    background: var(--card);
    border-radius: 24px 24px 0 0;
    border: 2px solid var(--ink);
    border-bottom: none;
    width: 100%; max-width: 480px;
    padding: 24px 24px 40px;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
    box-shadow: 0 -8px 40px rgba(26,20,16,0.15);
  }
  .modal-overlay.open .modal-sheet { transform: translateY(0); }
  .modal-handle {
    width: 36px; height: 4px;
    background: rgba(26,20,16,0.2);
    border-radius: 2px;
    margin: 0 auto 20px;
  }
  .modal-title {
    font-family: 'Syne', sans-serif;
    font-size: 20px; font-weight: 800;
    color: var(--ink); margin-bottom: 20px;
  }
  .modal-input {
    width: 100%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 2px solid rgba(26,20,16,0.2);
    background: var(--bg);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    outline: none;
    margin-bottom: 12px;
    transition: border-color 0.15s;
  }
  .modal-input:focus { border-color: var(--ink); }
  .modal-inputs-row {
    display: flex; gap: 10px; margin-bottom: 16px;
  }
  .modal-inputs-row .modal-input { margin-bottom: 0; }
  .modal-cat-select {
    width: 100%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 2px solid rgba(26,20,16,0.2);
    background: var(--bg);
    font-family: 'Syne', sans-serif;
    font-size: 14px; font-weight: 600;
    color: var(--ink);
    outline: none;
    margin-bottom: 16px;
    cursor: pointer;
  }

  /* highlight-left/right for swipe */
  .opt.highlight-left { background: rgba(255,107,53,0.12); border-color: var(--accent); }
  .opt.highlight-right { background: rgba(46,204,122,0.12); border-color: var(--match); }
  #screen-match { gap: 0; text-align: center; }

  .match-score-ring {
    width: 160px; height: 160px;
    position: relative;
    margin: 0 auto 28px;
  }
  .match-score-ring svg { transform: rotate(-90deg); }
  .ring-bg { fill: none; stroke: rgba(26,20,16,0.1); stroke-width: 10; }
  .ring-fg { fill: none; stroke: var(--match); stroke-width: 10; stroke-linecap: round;
    stroke-dasharray: 440; stroke-dashoffset: 440;
    transition: stroke-dashoffset 1.5s cubic-bezier(0.4,0,0.2,1);
  }
  .ring-text {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
  }
  .ring-pct {
    font-family: 'Syne', sans-serif;
    font-size: 40px; font-weight: 800;
    color: var(--ink); line-height: 1;
  }
  .ring-label {
    font-size: 11px; color: var(--muted);
    letter-spacing: 1px; text-transform: uppercase;
    font-weight: 500;
  }

  .match-title {
    font-family: 'Syne', sans-serif;
    font-size: 28px; font-weight: 800;
    color: var(--ink); margin-bottom: 8px;
    letter-spacing: -0.5px;
  }
  .match-subtitle {
    font-size: 14px; color: var(--muted);
    margin-bottom: 32px; line-height: 1.6;
    max-width: 280px;
  }

  /* Results list */
  .results-scroll {
    width: 100%; max-width: 420px;
    max-height: 260px;
    overflow-y: auto;
    border-radius: 16px;
    border: 2px solid var(--ink);
    background: var(--card);
    margin-bottom: 24px;
    scrollbar-width: thin;
  }
  .result-item {
    display: grid; grid-template-columns: 1fr 28px 1fr 32px;
    align-items: center;
    padding: 10px 14px;
    border-bottom: 1px solid rgba(26,20,16,0.06);
    gap: 8px;
  }
  .result-chat-btn {
    width: 26px; height: 26px;
    border-radius: 50%;
    background: transparent;
    border: 1.5px solid rgba(26,20,16,0.2);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .result-chat-btn:hover { background: var(--ink); border-color: var(--ink); }
  .quiz-back-btn {
    width: 34px; height: 34px;
    border-radius: 10px;
    border: 2px solid rgba(26,20,16,0.15);
    background: transparent;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    transition: all 0.15s;
    opacity: 0; pointer-events: none;
  }
  .quiz-back-btn.visible { opacity: 1; pointer-events: all; }
  .quiz-back-btn:hover { border-color: var(--ink); }
  .result-item:last-child { border-bottom: none; }
  .result-a { text-align: right; font-size: 13px; font-weight: 500; color: var(--ink); }
  .result-b { text-align: left; font-size: 13px; font-weight: 500; color: var(--ink); }
  .result-a.winner { color: var(--match); font-weight: 700; }
  .result-b.winner { color: var(--match); font-weight: 700; }
  .result-dot {
    width: 16px; height: 16px;
    border-radius: 50%;
    margin: 0 auto;
  }
  .dot-match { background: var(--match); }
  .dot-nomatch { background: var(--nomatch); }
  .dot-skip { background: var(--skip); }

  .results-legend {
    display: flex; gap: 16px; justify-content: center;
    margin-bottom: 24px; flex-wrap: wrap;
  }
  .legend-item {
    display: flex; align-items: center; gap: 6px;
    font-size: 12px; color: var(--muted);
  }
  .legend-dot {
    width: 10px; height: 10px; border-radius: 50%;
  }

  .btn-secondary {
    padding: 14px 32px;
    background: transparent;
    color: var(--ink);
    border: 2px solid var(--ink);
    border-radius: 100px;
    font-family: 'Syne', sans-serif;
    font-size: 14px; font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.5px;
    transition: all 0.18s;
    margin-left: 12px;
  }
  .btn-secondary:hover { background: var(--ink); color: var(--bg); }

  .btn-row { display: flex; gap: 0; flex-wrap: wrap; justify-content: center; }

  /* Selected option highlight during swipe */
  .opt.highlight-left { background: rgba(255,107,53,0.12); border-color: var(--accent); }
  .opt.highlight-right { background: rgba(46,204,122,0.12); border-color: var(--match); }

  /* Confetti dots */
  .confetti-container {
    position: fixed; inset: 0; pointer-events: none; z-index: 100; overflow: hidden;
  }
  .confetti-dot {
    position: absolute;
    width: 8px; height: 8px;
    border-radius: 2px;
    animation: confetti-fall 1.2s ease-out forwards;
  }
  @keyframes confetti-fall {
    0% { opacity: 1; transform: translateY(-20px) rotate(0deg); }
    100% { opacity: 0; transform: translateY(100vh) rotate(720deg); }
  }


  /* ‚îÄ‚îÄ AUTH SCREENS ‚îÄ‚îÄ */
  .auth-screen {
    position: fixed; inset: 0;
    background: var(--bg);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 32px 24px;
    z-index: 500;
  }
  .auth-screen.hidden { display: none; }
  .auth-logo { margin-bottom: 8px; }
  .auth-title { font-family: 'Syne', sans-serif; font-size: 36px; font-weight: 900; color: var(--ink); margin-bottom: 4px; }
  .auth-sub { font-size: 14px; color: var(--muted); margin-bottom: 36px; text-align: center; max-width: 280px; }
  .auth-form { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 12px; }
  .auth-input {
    width: 100%; padding: 14px 16px;
    border: 2px solid rgba(26,20,16,0.2);
    border-radius: 14px;
    font-family: 'DM Sans', sans-serif; font-size: 15px;
    background: var(--card); color: var(--ink);
    outline: none; box-sizing: border-box;
    transition: border-color 0.15s;
  }
  .auth-input:focus { border-color: var(--ink); }
  .auth-input::placeholder { color: var(--muted); }
  .auth-btn {
    margin-top: 8px;
    padding: 16px;
    background: var(--ink); color: var(--bg);
    border: none; border-radius: 100px;
    font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700;
    cursor: pointer; transition: opacity 0.15s;
    letter-spacing: 0.5px;
  }
  .auth-btn:hover { opacity: 0.85; }
  .auth-switch {
    margin-top: 20px; font-size: 13px; color: var(--muted); text-align: center;
  }
  .auth-switch span {
    color: var(--ink); font-weight: 700; cursor: pointer; text-decoration: underline;
  }
  .auth-error {
    color: var(--nomatch); font-size: 12px; text-align: center;
    min-height: 16px; margin-top: -4px;
  }
  .auth-user-badge {
    position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
    font-family: 'Syne', sans-serif; font-size: 11px; font-weight: 700;
    color: var(--muted); z-index: 10;
    letter-spacing: 0.5px;
    white-space: nowrap;
    pointer-events: none;
  }

  /* Transition animations */
  @keyframes card-in {
    0% { opacity: 0; transform: scale(0.94) translateY(20px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
  }
  .card-animate-in { animation: card-in 0.35s cubic-bezier(0.34,1.56,0.64,1) forwards; }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

</style>
</head>
<body>
<div class="auth-user-badge" id="user-badge"></div>

<!-- AUTH: REGISTER / LOGIN -->
<div class="auth-screen" id="screen-auth">
  <div class="auth-logo logo-mark" style="width:56px;height:56px;margin-bottom:16px;">
    <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="14" cy="14" r="7" fill="#FFD166"/>
      <circle cx="26" cy="26" r="7" fill="#FF6B35"/>
      <path d="M14 21 C14 21 18 26 26 19" stroke="#FFFDF8" stroke-width="2.5" stroke-linecap="round"/>
    </svg>
  </div>
  <div class="auth-title">Alike</div>

  <!-- Register form -->
  <div id="auth-register-view">
    <div class="auth-sub">Get to know your people better.</div>
    <div class="auth-form">
      <input class="auth-input" id="reg-username" type="text" placeholder="Username" autocomplete="username" />
      <input class="auth-input" id="reg-email" type="email" placeholder="E-Mail" autocomplete="email" />
      <input class="auth-input" id="reg-password" type="password" placeholder="Password" autocomplete="new-password" />
      <div class="auth-error" id="reg-error"></div>
      <button class="auth-btn" onclick="doRegister()">Create account ‚Üí</button>
    </div>
    <div class="auth-switch">Already have an account? <span onclick="showLogin()">Log in</span></div>
  </div>

  <!-- Login form -->
  <div id="auth-login-view" style="display:none;">
    <div class="auth-sub">Welcome back.</div>
    <div class="auth-form">
      <input class="auth-input" id="login-email" type="email" placeholder="E-Mail" autocomplete="email" />
      <input class="auth-input" id="login-password" type="password" placeholder="Password" autocomplete="current-password" />
      <div class="auth-error" id="login-error"></div>
      <button class="auth-btn" onclick="doLogin()">Log in ‚Üí</button>
    </div>
    <div class="auth-switch">No account yet? <span onclick="showRegister()">Register</span></div>
    <div class="auth-switch" style="margin-top:8px;">Forgot password? <span onclick="showForgotPassword()">Reset it</span></div>
  </div>

  <!-- Forgot password -->
  <div id="auth-forgot-view" style="display:none;">
    <div class="auth-sub">Enter your e-mail and we'll show your password.</div>
    <div class="auth-form">
      <input class="auth-input" id="forgot-email" type="email" placeholder="E-Mail" />
      <div class="auth-error" id="forgot-error"></div>
      <div id="forgot-result" style="font-size:13px;color:var(--ink);text-align:center;min-height:20px;font-weight:600;"></div>
      <button class="auth-btn" onclick="doForgotPassword()">Show password ‚Üí</button>
    </div>
    <div class="auth-switch"><span onclick="showLogin()">‚Üê Back to login</span></div>
  </div>

  <!-- Change password (in-app, from settings) -->
  <div id="auth-change-pw-view" style="display:none;">
    <div class="auth-sub">Choose a new password.</div>
    <div class="auth-form">
      <input class="auth-input" id="change-pw-current" type="password" placeholder="Current password" />
      <input class="auth-input" id="change-pw-new" type="password" placeholder="New password (min. 6 chars)" />
      <div class="auth-error" id="change-pw-error"></div>
      <button class="auth-btn" onclick="doChangePassword()">Save new password ‚Üí</button>
    </div>
    <div class="auth-switch"><span onclick="cancelChangePassword()">‚Üê Cancel</span></div>
  </div>
</div>

<!-- WELCOME SCREEN -->
<div class="screen" id="screen-welcome">
  <div class="logo-mark">
    <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="14" cy="14" r="7" fill="#FFD166"/>
      <circle cx="26" cy="26" r="7" fill="#FF6B35"/>
      <path d="M14 21 C14 21 18 26 26 19" stroke="#FFFDF8" stroke-width="2.5" stroke-linecap="round"/>
    </svg>
  </div>
  <h1>Alike</h1>
  <p class="tagline">Find out what you really have in common.</p>

  <div class="categories">
    <div class="cat-chip active" data-cat="Lifestyle">Lifestyle</div>
    <div class="cat-chip" data-cat="Food">Food</div>
    <div class="cat-chip" data-cat="Love">Love</div>
    <div class="cat-chip" data-cat="Music">Music</div>
    <div class="cat-chip" data-cat="Travel">Travel</div>
    <div class="cat-chip" data-cat="Culture">Culture</div>
    <div class="cat-chip" data-cat="Sports">Sports</div>
    <div class="cat-chip" data-cat="Values">Values</div>
    <div class="cat-chip" data-cat="People">People</div>
    <div class="cat-chip" data-cat="Future">Future</div>
    <div class="cat-chip" data-cat="Popular">Popular</div>
    <div class="cat-chip" data-cat="Random">Random</div>
  </div>

  <button class="btn-primary" onclick="startQuiz()">Start Matching ‚Üí</button>
</div>

<!-- QUIZ SCREEN -->
<div class="screen hidden" id="screen-quiz">
  <div class="quiz-header" style="padding: 12px 4px 8px;">
    <button class="quiz-back-btn" id="quiz-back-btn" onclick="goBack()">‚Üê</button>
  </div>

  <div class="card-stage">
    <div class="question-card card-animate-in" id="question-card">
      <div class="swipe-hint left" id="hint-left">‚Üê This</div>
      <div class="swipe-hint right" id="hint-right">That ‚Üí</div>
      <div class="swipe-hint up" id="hint-up">‚Üë Skip</div>

      <!-- Category + progress + counter inside card, flush to top -->
      <div style="width:100%; position:absolute; top:0; left:0; right:0; padding:14px 20px 12px; border-bottom: 1px solid rgba(26,20,16,0.07);">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:7px;">
          <div class="quiz-cat" id="quiz-cat-label">Lifestyle</div>
          <div class="quiz-counter" id="quiz-counter" style="font-size:12px; padding:3px 10px;">1 / 20</div>
        </div>
        <div class="progress-bar" style="margin-bottom:0; height:3px;">
          <div class="progress-fill" id="progress-fill" style="width:5%"></div>
        </div>
      </div>

      <div class="card-label" id="card-label" style="margin-top:32px;">What's more you?</div>
      <div class="options-row">
        <div class="opt" id="opt-left" onclick="answerClick('left')">
          <div class="opt-text" id="opt-left-text">Early bird</div>
        </div>
        <div class="or-badge">OR</div>
        <div class="opt" id="opt-right" onclick="answerClick('right')">
          <div class="opt-text" id="opt-right-text">Night owl</div>
        </div>
      </div>
    </div>
  </div>

  <!-- New action bar: Like / Skip / New Question -->
  <div class="action-bar">
    <div class="action-item" onclick="likeQuestion()">
      <div class="action-circle" id="like-btn">üëç</div>
      <div class="action-label">Nice one</div>
    </div>
    <div class="action-item skip-btn" onclick="answer('skip')">
      <div class="action-circle" style="font-size:17px; font-weight:800; font-family:'Syne',sans-serif;">>></div>
      <div class="action-label">Skip</div>
    </div>
    <div class="action-item" onclick="openNewQuestionModal()">
      <div class="action-circle">Ôºã</div>
      <div class="action-label">New question</div>
    </div>
  </div>
</div>

<!-- SHARE SCREEN (Person A invites Person B) -->
<div class="screen hidden" id="screen-share">
  <div class="logo-mark" style="margin-bottom:20px">
    <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="14" cy="14" r="7" fill="#FFD166"/>
      <circle cx="26" cy="26" r="7" fill="#FF6B35"/>
      <path d="M14 21 C14 21 18 26 26 19" stroke="#FFFDF8" stroke-width="2.5" stroke-linecap="round"/>
    </svg>
  </div>
  <div class="match-title">Profile Complete!</div>
  <div class="match-subtitle" style="max-width:320px">You've answered all questions. Now invite a friend to see how you match!</div>

  <div style="background:var(--card); border:2px solid var(--ink); border-radius:16px; padding:20px; max-width:380px; margin:24px 0;">
    <div style="font-size:11px; font-weight:600; letter-spacing:1px; text-transform:uppercase; color:var(--muted); margin-bottom:8px;">Your Match Link</div>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="text" id="share-link" readonly style="flex:1; padding:10px 14px; border:1.5px solid rgba(26,20,16,0.2); border-radius:10px; font-size:13px; font-family:'DM Sans',sans-serif; background:var(--bg);" value="">
      <button class="action-btn" onclick="copyLink()" title="Copy link" style="flex-shrink:0;">üìã</button>
    </div>
    <div id="copy-feedback" style="font-size:11px; color:var(--match); margin-top:8px; opacity:0; transition:opacity 0.3s;">‚úì Link copied!</div>
  </div>

  <div class="btn-row" style="gap:10px;">
    <button class="btn-primary" onclick="shareNative()">Share ‚Üí</button>
    <button class="btn-secondary" onclick="goHome()" style="margin-left:0;">‚Üê Home</button>
  </div>
</div>

<!-- WAITING SCREEN (Person A waits for Person B) -->
<div class="screen hidden" id="screen-waiting">
  <div class="logo-mark" style="margin-bottom:20px; animation: pulse 2s ease-in-out infinite;">
    <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="14" cy="14" r="7" fill="#FFD166"/>
      <circle cx="26" cy="26" r="7" fill="#FF6B35"/>
      <path d="M14 21 C14 21 18 26 26 19" stroke="#FFFDF8" stroke-width="2.5" stroke-linecap="round"/>
    </svg>
  </div>
  <div class="match-title">‚è≥ Waiting for your match...</div>
  <div class="match-subtitle" style="max-width:320px">We'll show your results as soon as they finish answering!</div>
  
  <button class="btn-primary" onclick="checkMatch()" style="margin-top:24px;">Check Status</button>
  <button class="btn-secondary" onclick="goHome()">‚Üê Home</button>
</div>

<!-- MATCH SCREEN -->
<div class="screen hidden" id="screen-match">
  <div class="match-score-ring">
    <svg width="160" height="160" viewBox="0 0 160 160">
      <circle class="ring-bg" cx="80" cy="80" r="70"/>
      <circle class="ring-fg" id="ring-fg" cx="80" cy="80" r="70"/>
    </svg>
    <div class="ring-text">
      <div class="ring-pct" id="match-pct">0%</div>
      <div class="ring-label">Match</div>
    </div>
  </div>

  <div class="match-title" id="match-verdict">Great Match!</div>
  <div class="match-subtitle" id="match-desc">You and your friend share lots of tastes. Lots to talk about!</div>

  <div class="results-legend">
    <div class="legend-item"><div class="legend-dot" style="background:var(--match)"></div> Same taste</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--nomatch)"></div> Different</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--skip)"></div> Skipped</div>
  </div>

  <div class="results-scroll" id="results-list"></div>

  <div class="btn-row">
    <button class="btn-primary" onclick="restartQuiz()">Play Again</button>
    <button class="btn-secondary" onclick="goHome()">‚Üê Home</button>
  </div>
</div>

<div class="confetti-container" id="confetti-container"></div>

<script>
const QUESTIONS = {
  Lifestyle: [
    {l:'Early bird', r:'Night owl'},
    {l:'Phone first thing', r:'Coffee first thing'},
    {l:'Stay in', r:'Go out'},
    {l:'Read', r:'Watch TV'},
    {l:'Tidy freak', r:'Organized chaos'},
    {l:'Slow mornings', r:'Rush mornings'},
    {l:'Save money', r:'Spend money'},
    {l:'Dog person', r:'Cat person'},
    {l:'Minimalist', r:'Maximalist'},
    {l:'Planner', r:'Improviser'},
    {l:'City life', r:'Country life'},
    {l:'Healthy habits', r:'Treat yourself'},
    {l:'Logic', r:'Feelings'},
    {l:'Talk it out', r:'Write it out'},
    {l:'Social butterfly', r:'Homebody'},
    {l:'Sneakers', r:'Dressed up'},
    {l:'Black always', r:'Color lover'},
    {l:'Fitted clothes', r:'Oversized'},
    {l:'Shop often', r:'Wear what you have'},
    {l:'Phone on silent', r:'Notifications on'},
  ],
  Food: [
    {l:'Cooking at home', r:'Ordering in'},
    {s:'It\'s 9am and you have nowhere to be.', l:'Sit-down brunch', r:'Coffee and gone'},
    {l:'Tea', r:'Coffee'},
    {l:'Sushi', r:'Pizza'},
    {l:'Beer', r:'Wine'},
    {l:'Scrambled eggs', r:'Fried eggs'},
    {l:'Cookies', r:'Cake'},
    {l:'Local food', r:'Global cuisine'},
    {l:'Croissant', r:'Cigarette'},
    {l:'Thai', r:'Italian'},
    {l:'Still', r:'Sparkling'},
    {l:'Fish fingers', r:'Oysters'},
    {l:'Meat', r:'Vegetarian'},
    {l:'Fast food', r:'Slow food'},
    {s:'A sketchy cart on a side street. Smells incredible.', l:'Can‚Äôt resist', r:'Hard pass'},
    {s:'The avocado toast is $22.', l:'Order it anyway', r:'Make it at home and feel smug'},
    {s:'The bill arrives. Nobody\'s moving.', l:'Split it exactly', r:'I\'ll get this one'},
    {s:'You\'re hungover. It\'s bad.', l:'McDonald\'s', r:'Water and regret'},
    {s:'The bread basket just landed.', l:'Pace yourself', r:'It\'s already gone'},
    {s:'The spice level said medium. It\'s destroying you.', l:'Push through', r:'Tap out'},
    {s:'There\'s one piece left on the table.', l:'Take it', r:'Leave it'},
    {s:'The restaurant is fully booked.', l:'Find somewhere else', r:'Wait at the bar'},
    {s:'Dinner party. The host\'s food is bad.', l:'Say nothing', r:'Say something'},
    {s:'The tasting menu is 11 courses.', l:'Dream', r:'Nightmare'},
    {s:'It\'s a BBQ. You\'re first in line.', l:'Straight to the meat', r:'Straight to the sides'},
    {l:'Cooking is therapy', r:'Cooking is work'},
    {l:'Meal plan for the week', r:'Figure it out daily'},
    {l:'Let the food speak', r:'Hot sauce on everything'},
    {l:'Eat the leftovers', r:'Order fresh'},
    {l:'Reservations weeks ahead', r:'Walk in and wing it'},
    {s:'Eating alone at a restaurant.', l:'Fine', r:'Mildly uncomfortable'},
    {l:'Tapas to share', r:'Hands off my plate'},
    {l:'Your usual', r:'The chef\'s special'},
    {s:'Your cookbooks are for', l:'Cooking', r:'Looking good on the shelf'},
    {s:'Grocery shopping.', l:'Get inspired', r:'Just what‚Äôs on the list'},
    {l:'Chopsticks', r:'Fork always'},
    {s:'Should we order dessert?', l:'Always yes', r:'Only if it\'s worth it'},
    {l:'Wine pairing suggestions', r:'House wine'},
    {s:'Eating at', l:'the counter watching the chefs', r:'a proper table'},
    {l:'Gordon Ramsay\'s restaurant', r:'Salt Bae\'s restaurant'},
    {s:'You\'re cooking for someone you want to impress.', l:'Full three-course effort', r:'Order in and plate it nicely'},
    {s:'Saturday morning. Let‚Äôs go get groceries at the', l:'Farmers market', r:'Supermarket'},
    {l:'Secret menu item', r:'The classic everyone orders'},
    {l:'Espresso', r:'Americano'},
    {l:'Natural wine', r:'Classic wine'},
    {l:'Sourdough', r:'White bread'},
    {l:'Spaghetti', r:'Linguine'},
    {l:'Ros√©', r:'Prosecco'},
    {s:'My main meal is', l:'Lunch', r:'Dinner'},
    {l:'Eat at the table', r:'Eat on the sofa'},
    {l:'French cuisine', r:'Japanese cuisine'},
    {l:'Olive oil', r:'Butter'},
    {l:'Cook with music on', r:'Cook in silence'},
    {l:'Ramen', r:'Pho'},
    {l:'Steak', r:'Fish'},
    {l:'Salad as a meal', r:'Salad as a side'},
    {l:'Oat milk', r:'Cow milk'},
    {s:'The restaurant has no menu. The chef decides.', l:'Let\'s go', r:'Let‚Äôs not'},
    {s:'The recipe says 200ml of wine.', l:'Measure exactly', r:'Measure intuitively'},
    {s:'Your friend is 30 minutes late for dinner. You:', l:'Order', r:'Leave'},
    {s:'Which wine?', l:'Let the waiter recommend', r:'Let me see the wine list'},
    {s:'Plates arrive, the food looks beautiful.', l:'Get a good shot first', r:'Just dig in'},
    {s:'You\'re in a new city for one night.', l:'Ask a local where to eat', r:'Check the reviews'},
    {s:'The menu is only in the local language.', l:'Exciting', r:'Unsettling'},
    {s:'You\'re in Spain. Dinner starts at 10pm.', l:'That‚Äôs vacation', r:'That‚Äôs starvation'},
    {l:'Brunch', r:'Something quick'},
    {l:'Eat seasonally', r:'What you want when you want'},
    {l:'Sit outside whenever possible', r:'Inside always'},
    {l:'Cook from memory', r:'Cook from a recipe'},
    {l:'Negroni', r:'Aperol Spritz'},
    {l:'Dim sum', r:'Mezze'},
    {l:'Set menu', r:'√Ä la carte'},
    {l:'Eat with your hands', r:'Eat with cutlery'},
    {l:'Indian', r:'Mexican'},
    {l:'New place everyone\'s talking about', r:'Neighbourhood spot you love'},
    {l:'Medium rare', r:'Well done'},
    {l:'Food is fuel', r:'Food is pleasure'},
    {s:'Your friend is doing a cleanse.', l:'Respect it', r:'Order the pizza anyway'},
    {s:'The restaurant has a Michelin star. It shows in the bill.', l:'Worth every cent', r:'Instant regret'},
    {s:'You cooked something new. It didn\'t work out.', l:'Order pizza', r:'Try to fix it'},
    {s:'The delivery guy has been arriving in 2 minutes for 20 minutes.', l:'Go outside look for him', r:'Call him and give directions'},
    {s:'A spot just opened up at the hottest place in town. Tuesday, 5:30.', l:'Whatever, just take it', r:'Show some dignity'},
    {s:'Open kitchen. Your friends are watching you cook.', l:'Heaven', r:'Hell'},
    {s:'The dinner date picks a restaurant with no prices on the menu.', l:'Exciting', r:'Mildly stressful'},
    {s:'Your friend lost 15 pounds on Ozempic.', l:'Good for them', r:'Complicated feelings'},
    {s:'A protein shake is technically a meal.', l:'Deeply sad', r:'Efficient'},
    {l:'Oat milk frappuccino latte', r:'Just a coffee'},
    {s:'Your fridge has: leftover rice, spring onions, eggs.', l:'Make something good', r:'Order in'},
    {s:'Dinner party. You said just bring yourself. Your friends bring:', l:'Wine', r:'A dish nobody asked for'},
    {s:'You\'re eating alone. You:', l:'Proper meal anyway', r:'Crackers over the sink'},
    {s:'A first date suggests cooking together at home.', l:'Intimate and fun', r:'Too much pressure'},
    {s:'The menu is QR code only. No paper.', l:'Fine', r:'Not a fan'},
    {s:'You went plant-based for January. It\'s January 14th.', l:'Still going', r:'The chorizo won'},
    {s:'The chef comes to your table to explain the dish for three minutes.', l:'Please tell me more', r:'Please let me eat'},
    {s:'It\'s a long lunch. Your afternoon is gone.', l:'Perfect Wednesday', r:'Mild guilt the whole time'},
    {s:'The new place has a 4.9 on Google.', l:'Reviews are useless', r:'Can‚Äôt wait to check it out'},
    {l:'Collagen in your coffee', r:'Hard no'},
    {l:'Intermittent fasting', r:'Breakfast within 10 minutes of waking'},
    {l:'Gut health is optional', r:'Gut health is important'},
    {l:'Everyone brings a dish', r:'One person cooks everything'},
    {l:'Always tip same percentage', r:'Tipping based on service'},
    {s:'Food trends.', l:'Interested', r:'Don‚Äôt care'},
    {s:'You cooked a full meal. The kitchen looks like a crime scene.', l:'Feeling happy', r:'Feeling guilty'},
    {s:'The delivery guy called. He\'s outside. He is not outside.', l:'Stay calm', r:'Break something'},
    {l:'Table dinner', r:'TV dinner'},
    {l:'Ugly food that tastes incredible', r:'Beautiful food that\'s average'},
    {s:'You\'re on a diet. Someone brings cake to the office.', l:'One slice back on track tomorrow', r:'None. Discipline.'},
    {s:'What‚Äôs in your fridge?', l:'Pretty much everything', r:'Meds, Champagne, an onion'},
    {s:'Something‚Äôs left on your plate but you‚Äôre not hungry any more.', l:'Leave it', r:'Finish it'},
    {s:'There are things on the menu you don‚Äôt understand.', l:'Ask the waiter', r:'Google it'},
    {s:'The celebrity clearly used GLP-1. Won\'t admit it.', l:'Their business', r:'Just say it'},
  ],
  Love: [
    {l:'Text first', r:'Call first'},
    {l:'Grand gestures', r:'Small everyday moments'},
    {l:'Stay in date', r:'Go out date'},
    {l:'Talk about feelings', r:'Show through actions'},
    {l:'PDA', r:'Keep it private'},
    {l:'Give gifts', r:'Give time'},
    {l:'Move in together early', r:'Keep own place longer'},
    {l:'Constant texting', r:'Space to breathe'},
    {l:'Marriage', r:'Commitment without it'},
    {l:'Kids', r:'No kids'},
    {l:'Fall fast', r:'Take it slow'},
    {l:'Physical touch', r:'Words of affirmation'},
    {l:'Plan dates', r:'Spontaneous dates'},
    {l:'Couple trips', r:'Solo trips too'},
    {l:'Big birthday fuss', r:'Low-key birthday'},
    {l:'Best friends first', r:'Chemistry first'},
    {l:'Share everything', r:'Keep some things private'},
    {l:'Same sleep schedule', r:'Different schedules ok'},
    {l:'Mark every anniversary', r:'Just another day'},
    {l:'Post about us online', r:'Keep it offline'},
  ],
  Music: [
    {l:'Rock', r:'Pop'},
    {l:'Headphones', r:'Speakers'},
    {l:'Live concert', r:'Streaming at home'},
    {l:'Lyrics matter', r:'Beat matters'},
    {l:'Classical', r:'Jazz'},
    {l:'One genre', r:'All genres'},
    {l:'Radio', r:'Curated playlist'},
    {l:'Karaoke', r:'Never karaoke'},
    {l:'Loud', r:'Background music'},
    {l:'Old classics', r:'New releases'},
    {l:'Podcasts', r:'Music only'},
    {l:'Dance to it', r:'Really listen'},
    {l:'Full albums', r:'Just the singles'},
    {l:'Acoustic', r:'Electronic'},
    {l:'Follow the artist', r:'Follow the producer'},
    {l:'One instrument', r:'Full band'},
    {l:'World music', r:'Local music'},
    {l:'Sad songs', r:'Feel-good songs'},
    {l:'Festival', r:'Intimate venue'},
    {l:'Spotify', r:'Apple Music'},
  ],
  Travel: [
    {l:'Beach', r:'Mountains'},
    {l:'Fly', r:'Train'},
    {l:'Hotel', r:'Camping'},
    {l:'Plan ahead', r:'Just go'},
    {l:'Far away', r:'Close to home'},
    {l:'City trip', r:'Nature escape'},
    {l:'Local food always', r:'Familiar comfort food'},
    {l:'Famous sights', r:'Hidden gems'},
    {l:'Overpack', r:'One carry-on'},
    {l:'All-inclusive', r:'DIY adventure'},
    {l:'Travel with friends', r:'Solo travel'},
    {l:'Summer holiday', r:'Winter escape'},
    {l:'History & culture', r:'Fun & thrills'},
    {l:'Cruise', r:'Road trip'},
    {l:'New destination every time', r:'Return to favorites'},
    {l:'Sunrise hike', r:'Nightlife explorer'},
    {l:'Read about it before', r:'Explore on arrival'},
    {l:'Luxury accommodation', r:'Budget & spend elsewhere'},
    {l:'Make friends abroad', r:'Travel bubble only'},
    {l:'Backpacker', r:'Comfort traveler'},
  ],
  Culture: [
    {l:'Comedy', r:'Thriller'},
    {l:'Cinema', r:'Sofa stream'},
    {l:'Blockbuster', r:'Arthouse'},
    {l:'Fantasy', r:'Sci-Fi'},
    {l:'Sad ending', r:'Happy ending'},
    {l:'Series', r:'Films'},
    {l:'Gaming', r:'Reading'},
    {l:'Theater', r:'Stand-up comedy'},
    {l:'True crime', r:'Literary fiction'},
    {l:'Documentary', r:'Reality TV'},
    {l:'One episode a week', r:'Binge it all'},
    {l:'Art museum', r:'Science museum'},
    {l:'Read the news', r:'Hear the news'},
    {l:'Physical books', r:'E-reader'},
    {l:'Contemporary art', r:'Classical art'},
    {l:'Foreign films', r:'Domestic films'},
    {l:'Fiction', r:'Non-fiction'},
    {l:'Go to an exhibition', r:'Watch a doc instead'},
    {l:'Board games', r:'Video games'},
    {l:'Director fan', r:'Actor fan'},
  ],
  Sports: [
    {l:'Football', r:'Basketball'},
    {l:'Swimming', r:'Running'},
    {l:'Watch sport', r:'Play sport'},
    {l:'Gym', r:'Yoga'},
    {l:'Team sport', r:'Solo sport'},
    {l:'Morning workout', r:'Evening workout'},
    {l:'Competitive', r:'Just for fun'},
    {l:'Winter sport', r:'Summer sport'},
    {l:'Precision', r:'Speed'},
    {l:'Outdoors', r:'Indoors'},
    {l:'Tennis', r:'Badminton'},
    {l:'Climbing', r:'Cycling'},
    {l:'Boxing', r:'Martial arts'},
    {l:'Stats & tactics', r:'Pure passion'},
    {l:'Stadium atmosphere', r:'Couch & snacks'},
    {l:'Energy drink', r:'Just water'},
    {l:'Train every day', r:'Train when I feel like it'},
    {l:'Enter competitions', r:'Never compete'},
    {l:'Stretch & warm up', r:'Jump straight in'},
    {l:'Proper kit', r:'Whatever fits'},
  ],
  Values: [
    {l:'Security', r:'Freedom'},
    {l:'Roots & stability', r:'Change & adventure'},
    {l:'Family first', r:'Self first'},
    {l:'Career driven', r:'Work to live'},
    {l:'Financial success', r:'Personal happiness'},
    {l:'Environment first', r:'Progress first'},
    {l:'Loyalty above all', r:'Honesty above all'},
    {l:'Head', r:'Heart'},
    {l:'Tradition', r:'Innovation'},
    {l:'Think global', r:'Act local'},
    {l:'Achievement', r:'Contentment'},
    {l:'Justice', r:'Peace'},
    {l:'Civic duty', r:'Personal morality'},
    {l:'Self-reliance', r:'Community'},
    {l:'Science & reason', r:'Intuition & spirit'},
    {l:'Speak your mind', r:'Choose your battles'},
    {l:'Move fast, fix later', r:'Get it right first time'},
    {l:'Principles over pragmatism', r:'Pragmatism wins'},
    {l:'Kids need structure', r:'Kids need freedom'},
    {l:'Duty to be healthy', r:'My body my choice'},
  ],
  People: [
    {l:'Many friends', r:'Few close ones'},
    {l:'Meet new people', r:'Stick with who you know'},
    {l:'Deep talks', r:'Easy banter'},
    {l:'Be the host', r:'Be the guest'},
    {l:'Keep in touch often', r:'Pick up where you left off'},
    {l:'Address conflict directly', r:'Let it go'},
    {l:'Hug hello', r:'Wave hello'},
    {l:'Smart friends', r:'Funny friends'},
    {l:'Emotionally supportive', r:'Practically helpful'},
    {l:'Remember every birthday', r:'Terrible with dates'},
    {l:'Advice giver', r:'Listener'},
    {l:'International circle', r:'Local community'},
    {l:'Always reachable', r:'Respond when I can'},
    {l:'Colleague can become friend', r:'Keep work & life separate'},
    {l:'Need time to open up', r:'Open book immediately'},
    {l:'Celebrate everything', r:'Low-key by default'},
    {l:'Friend group hangout', r:'One on one'},
    {l:'Share life online', r:'Keep it private'},
    {l:'Split everything equally', r:'Whoever earns more pays more'},
    {l:'Some things I do alone', r:'Everything together'},
  ],
  Future: [
    {l:'AI will save us', r:'AI is dangerous'},
    {l:'Mars colony is exciting', r:'Fix Earth first'},
    {l:'Live forever if you could', r:'Natural lifespan is enough'},
    {l:'Edit your genes', r:'Leave nature alone'},
    {l:'Megacities', r:'Back to nature'},
    {l:'Tech optimist', r:'Tech pessimist'},
    {l:'Universal basic income', r:'Work for what you earn'},
    {l:'One world government', r:'Nations stay separate'},
    {l:'Upload your mind', r:'Death is part of life'},
    {l:'Self-driving everywhere', r:'I\'ll drive myself'},
    {l:'Designer babies ok', r:'Not for humans to decide'},
    {l:'Veganism saves the planet', r:'Technology saves the planet'},
    {l:'Robots do all the work', r:'Humans need meaningful work'},
    {l:'Contact aliens', r:'Maybe don\'t'},
    {l:'Enhance your brain', r:'Train your brain naturally'},
    {l:'Climate change is solvable', r:'Climate change is irreversible'},
    {l:'School should teach coding', r:'School should teach creativity'},
    {l:'Open borders', r:'Controlled immigration'},
    {l:'Nuclear energy is the answer', r:'Renewables only'},
    {l:'Kids should have no phones', r:'Digital literacy from young'},
  ],
}

// All real categories for Random/Popular
const ALL_CATEGORIES = ['Lifestyle','Food','Love','Music','Travel','Culture','Sports','Values','People','Future'];

// Randomly flip left/right sides so answers aren't always predictable
function shuffleSides(qs) {
  return qs.map(q => Math.random() > 0.5 ? {s: q.s, l: q.r, r: q.l, _cat: q._cat, _catIdx: q._catIdx} : {...q});
}

function getRandomQuestions() {
  const pool = [];
  ALL_CATEGORIES.forEach(cat => {
    QUESTIONS[cat].forEach(q => pool.push({...q, _cat: cat}));
  });
  return shuffleSides(pool.sort(() => Math.random() - 0.5).slice(0, 20));
}

// Popular: questions sorted by likes (stored in localStorage)
function getPopularQuestions() {
  const pool = [];
  ALL_CATEGORIES.forEach(cat => {
    QUESTIONS[cat].forEach((q, i) => {
      const key = `likes_${cat}_${i}`;
      const likes = parseInt(localStorage.getItem(key) || '0');
      pool.push({...q, _cat: cat, _catIdx: i, _likes: likes});
    });
  });
  pool.sort((a, b) => b._likes - a._likes);
  const top = pool.slice(0, 20);
  return top;
}

const CATEGORY_EMOJI = {
  Lifestyle:'', Food:'', Love:'', Music:'',
  Travel:'', Culture:'', Sports:'', Values:'',
  People:'', Future:'', Random:'', Popular:''
};

let currentCat = 'Food';
let questions = [];
let currentIdx = 0;
let myAnswers = [];
let matchId = null;
let currentMatchData = null; // stores last match for chat context
let isPersonB = false;

// Drag state
let isDragging = false;
let startX = 0, startY = 0;
let currentX = 0, currentY = 0;
let card;

// ========== INITIALIZATION ==========

window.onload = function() {
  checkAuth();
  const params = new URLSearchParams(window.location.search);
  const cat = params.get('cat');
  const qenc = params.get('q');
  const answersA = params.get('a');
  const answersB = params.get('b');

  if (cat && qenc) {
    isPersonB = !!answersA && !answersB;
    currentCat = cat;
    questions = decodeQuestions(qenc, cat);

    if (answersA && answersB) {
      const match = {
        category: currentCat,
        questions: questions,
        personA: answersA.split('').map(c => c === 'l' ? 'left' : c === 'r' ? 'right' : 'skip'),
        personB: answersB.split('').map(c => c === 'l' ? 'left' : c === 'r' ? 'right' : 'skip')
      };
      showResultsForBoth(match);
    } else if (answersA && !answersB) {
      currentIdx = 0;
      myAnswers = [];
      document.getElementById('quiz-cat-label').textContent = currentCat;
      renderQuestion();
      show('screen-quiz');
    }
  }
};

// ========== NAVIGATION ==========

function goHome() {
  isPersonB = false;
  matchId = null;
  window.history.pushState({}, '', window.location.pathname);
  show('screen-welcome');
}

function startQuiz() {
  currentCat = document.querySelector('.cat-chip.active')?.dataset.cat || 'Lifestyle';
  
  if (currentCat === 'Random') {
    questions = getRandomQuestions();
  } else if (currentCat === 'Popular') {
    questions = shuffleSides(getPopularQuestions());
  } else {
    const picked = [...QUESTIONS[currentCat]].sort(() => Math.random() - 0.5).slice(0, Math.min(20, QUESTIONS[currentCat].length));
    questions = shuffleSides(picked);
  }

  currentIdx = 0;
  myAnswers = [];
  isPersonB = false;
  matchId = null;

  document.getElementById('quiz-cat-label').textContent = currentCat;
  renderQuestion();
  show('screen-quiz');
}

// ========== QUIZ LOGIC ==========

function renderQuestion() {
  const q = questions[currentIdx];
  document.getElementById('opt-left-text').textContent = q.l.trim();
  document.getElementById('opt-right-text').textContent = q.r.trim();

  // Setup sentence or default label
  const labelEl = document.getElementById('card-label');
  if (q.s) {
    labelEl.textContent = q.s;
  } else {
    labelEl.textContent = "What's more you?";
  }

  document.getElementById('quiz-counter').textContent = (currentIdx+1) + ' / ' + questions.length;
  document.getElementById('progress-fill').style.width = ((currentIdx+1)/questions.length*100) + '%';

  // Show/hide back button
  const backBtn = document.getElementById('quiz-back-btn');
  if (currentIdx > 0) backBtn.classList.add('visible');
  else backBtn.classList.remove('visible');

  // Reset opts
  document.getElementById('opt-left').className = 'opt';
  document.getElementById('opt-right').className = 'opt';

  // Reset hints
  document.getElementById('hint-left').textContent = '‚Üê ' + q.l.trim().split(' ').slice(-1)[0];
  document.getElementById('hint-right').textContent = q.r.trim().split(' ').slice(-1)[0] + ' ‚Üí';

  // Reset card
  card = document.getElementById('question-card');
  card.style.transform = '';
  card.style.transition = '';
  resetHints();
  card.classList.remove('card-animate-in');
  void card.offsetWidth;
  card.classList.add('card-animate-in');

  setupDrag();
}



function answer(choice) {
  myAnswers.push(choice);
  animateCardOut(choice, () => {
    currentIdx++;
    if (currentIdx >= questions.length) {
      finishQuiz();
    } else {
      renderQuestion();
    }
  });
}

function goBack() {
  if (currentIdx <= 0 || myAnswers.length === 0) return;
  myAnswers.pop();
  currentIdx--;
  renderQuestion();
}

function animateCardOut(direction, cb) {
  const c = document.getElementById('question-card');
  c.style.transition = 'transform 0.38s cubic-bezier(0.4,0,1,1), opacity 0.3s';
  if (direction === 'left') c.style.transform = 'translateX(-140%) rotate(-20deg)';
  else if (direction === 'right') c.style.transform = 'translateX(140%) rotate(20deg)';
  else c.style.transform = 'translateY(-120%) scale(0.9)';
  c.style.opacity = '0';
  setTimeout(cb, 380);
}

// Encode questions as compact index strings e.g. "foo3_lov1f_tra7"
function encodeQuestions(qs) {
  const catMap = {};
  Object.keys(QUESTIONS).forEach(k => { catMap[k] = k.slice(0,3).toLowerCase(); });
  return qs.map(q => {
    const cat = q._cat || currentCat;
    const key = catMap[cat] || cat.slice(0,3).toLowerCase();
    const srcList = QUESTIONS[cat] || [];
    let idx = srcList.findIndex(o => (o.l === q.l && o.r === q.r) || (o.l === q.r && o.r === q.l));
    if (idx < 0) idx = 0;
    const original = srcList[idx];
    const flipped = original && original.l !== q.l ? 'f' : '';
    return key + idx + flipped;
  }).join('_');
}

function decodeQuestions(encoded, fallbackCat) {
  const catMap = {};
  Object.keys(QUESTIONS).forEach(k => { catMap[k.slice(0,3).toLowerCase()] = k; });
  return encoded.split('_').map(part => {
    const m = part.match(/^([a-z]{3})(\d+)(f?)$/);
    if (!m) return null;
    const cat = catMap[m[1]] || fallbackCat;
    const idx = parseInt(m[2]);
    const flipped = m[3] === 'f';
    const q = QUESTIONS[cat] && QUESTIONS[cat][idx];
    if (!q) return null;
    return flipped ? {l: q.r, r: q.l, _cat: cat} : {...q, _cat: cat};
  }).filter(Boolean);
}

function finishQuiz() {
  if (isPersonB) {
    const params = new URLSearchParams(window.location.search);
    const answersStr = myAnswers.map(a => a[0]).join('');
    params.set('b', answersStr);
    const cat = params.get('cat');
    const answersA = params.get('a');
    const questionsData = decodeQuestions(params.get('q') || '', cat);
    const match = {
      category: cat,
      questions: questionsData,
      personA: answersA.split('').map(c => c === 'l' ? 'left' : c === 'r' ? 'right' : 'skip'),
      personB: answersStr.split('').map(c => c === 'l' ? 'left' : c === 'r' ? 'right' : 'skip')
    };
    window.history.replaceState({}, '', '?' + params.toString());
    showResultsForBoth(match);
  } else {
    const answersStr = myAnswers.map(a => a[0]).join('');
    const params = new URLSearchParams();
    params.set('cat', currentCat);
    params.set('a', answersStr);
    params.set('q', encodeQuestions(questions));
    const shareUrl = window.location.origin + window.location.pathname + '?' + params.toString();
    document.getElementById('share-link').value = shareUrl;
    show('screen-share');
  }
}

function copyLink() {
  const input = document.getElementById('share-link');
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand('copy');
  const feedback = document.getElementById('copy-feedback');
  feedback.style.opacity = '1';
  setTimeout(() => feedback.style.opacity = '0', 2000);
}

function buildMailtoLink() {
  const link = document.getElementById('share-link').value;
  const subject = encodeURIComponent('Someone wants your opinion on ' + currentCat + ' topics');
  const body = encodeURIComponent('Hey!\n\nAnswer these questions and see how much we have in common:\n\n' + link);
  return 'mailto:?subject=' + subject + '&body=' + body;
}

function shareNative() {
  // navigator.share on desktop (Mac) doesn't pass subject to mail client
  // Only use it on real mobile touch devices
  const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);
  if (isMobile && navigator.share) {
    navigator.share({
      title: 'Someone wants your opinion on ' + currentCat + ' topics',
      text: 'Answer these questions and see how much we have in common:\n',
      url: document.getElementById('share-link').value
    }).catch(() => { window.open(buildMailtoLink(), '_blank'); });
  } else {
    window.open(buildMailtoLink(), '_blank');
  }
}

function shareEmail() {
  window.open(buildMailtoLink(), '_blank');
}

function checkMatch() {
  const params = new URLSearchParams(window.location.search);
  const answersB = params.get('b');
  
  if (answersB) {
    window.location.reload();
  } else {
    alert('Your friend hasn\'t answered yet. Share the link with them!');
  }
}

// ========== RESULTS ==========

function showResultsForBoth(match) {
  const answersA = match.personA;
  const answersB = match.personB;
  
  // Compute match
  let matches = 0, total = 0;
  const resultItems = [];
  
  match.questions.forEach((q, i) => {
    const me = answersA[i];
    const friend = answersB[i];
    const lText = q.l.trim();
    const rText = q.r.trim();

    let status;
    if (me === 'skip' && friend === 'skip') {
      status = 'skip';
    } else if (me === 'skip' || friend === 'skip') {
      status = 'skip';
    } else {
      total++;
      if (me === friend) { matches++; status = 'match'; }
      else status = 'nomatch';
    }

    const meText = me === 'left' ? lText : me === 'right' ? rText : '‚Äì';
    const friendText = friend === 'left' ? lText : friend === 'right' ? rText : '‚Äì';

    resultItems.push({ meText, friendText, status, setup: q.s || '' });
  });

  const pct = total > 0 ? Math.round(matches/total*100) : 0;

  // Update UI
  document.getElementById('match-pct').textContent = pct + '%';

  let verdict, desc;
  if (pct >= 80) { verdict = 'Incredible Match!'; desc = 'This is what chemistry looks like. You are basically the same person.'; }
  else if (pct >= 60) { verdict = 'Great Match!'; desc = 'Plenty in common. Just enough differences.'; }
  else if (pct >= 40) { verdict = 'Solid Match!'; desc = 'Nice balance. Some overlap, some debate. Not bad at all.'; }
  else if (pct >= 20) { verdict = 'Light Match!'; desc = 'Different views. Excellent conversation fuel.'; }
  else { verdict = 'Barely a Match!'; desc = 'Almost no overlap. Congrats. You have unlimited talking points.'; }

  document.getElementById('match-verdict').textContent = verdict;
  document.getElementById('match-desc').textContent = desc;

  // Animate ring
  const circumference = 2 * Math.PI * 70;
  const offset = circumference - (pct/100) * circumference;
  const ring = document.getElementById('ring-fg');
  ring.style.strokeDasharray = circumference;
  ring.style.strokeDashoffset = circumference;
  if (pct >= 60) ring.style.stroke = 'var(--match)';
  else if (pct >= 40) ring.style.stroke = 'var(--accent2)';
  else if (pct >= 20) ring.style.stroke = 'var(--accent)';
  else ring.style.stroke = 'var(--nomatch)';

  // Results list
  const list = document.getElementById('results-list');
  list.innerHTML = resultItems.map((item, i) => `
    <div class="result-item" style="flex-direction:column; align-items:stretch; gap:4px;">
      ${item.setup ? `<div style="font-size:11px; color:var(--muted); text-align:center; padding-top:2px;">${item.setup}</div>` : ''}
      <div style="display:grid; grid-template-columns:1fr 28px 1fr 32px; align-items:center; gap:8px;">
        <div class="result-a${item.status === 'match' ? ' winner' : ''}">${item.meText}</div>
        <div class="result-dot dot-${item.status}"></div>
        <div class="result-b${item.status === 'match' ? ' winner' : ''}">${item.friendText}</div>
        <button class="result-chat-btn" onclick="openChatFromResult(${i})" title="Start a conversation about this">üí¨</button>
      </div>
    </div>
  `).join('');

  show('screen-match');

  // Animate ring after screen shows
  setTimeout(() => {
    ring.style.strokeDashoffset = offset;
  }, 200);

  // Animate score counter
  let count = 0;
  const pctEl = document.getElementById('match-pct');
  const interval = setInterval(() => {
    count = Math.min(count + Math.ceil(pct/30), pct);
    pctEl.textContent = count + '%';
    if (count >= pct) clearInterval(interval);
  }, 40);

  // Confetti if high match
  if (pct >= 70) launchConfetti();
}

function restartQuiz() {
  goHome();
}

// ========== DRAG & DROP ==========

function resetHints() {
  ['hint-left','hint-right','hint-up'].forEach(id => {
    document.getElementById(id).style.opacity = '0';
  });
  document.getElementById('opt-left').className = 'opt';
  document.getElementById('opt-right').className = 'opt';
}

function setupDrag() {
  card = document.getElementById('question-card');
  card.onmousedown = dragStart;
  card.ontouchstart = (e) => dragStart(e.touches[0]);
}

function dragStart(e) {
  isDragging = true;
  startX = e.clientX;
  startY = e.clientY;
  card.style.transition = 'none';

  document.onmousemove = dragMove;
  document.onmouseup = dragEnd;
  document.ontouchmove = (e) => dragMove(e.touches[0]);
  document.ontouchend = dragEnd;
}

function dragMove(e) {
  if (!isDragging) return;
  currentX = e.clientX - startX;
  currentY = e.clientY - startY;
  const rot = currentX * 0.08;
  card.style.transform = `translate(${currentX}px, ${currentY}px) rotate(${rot}deg)`;

  const absX = Math.abs(currentX);
  const absY = Math.abs(currentY);

  // Show hints
  if (currentX < -40) {
    document.getElementById('hint-left').style.opacity = Math.min(1, absX/100);
    document.getElementById('hint-right').style.opacity = '0';
    document.getElementById('hint-up').style.opacity = '0';
    document.getElementById('opt-left').className = 'opt highlight-left';
    document.getElementById('opt-right').className = 'opt';
  } else if (currentX > 40) {
    document.getElementById('hint-right').style.opacity = Math.min(1, absX/100);
    document.getElementById('hint-left').style.opacity = '0';
    document.getElementById('hint-up').style.opacity = '0';
    document.getElementById('opt-right').className = 'opt highlight-right';
    document.getElementById('opt-left').className = 'opt';
  } else if (currentY < -40) {
    document.getElementById('hint-up').style.opacity = Math.min(1, absY/80);
    document.getElementById('hint-left').style.opacity = '0';
    document.getElementById('hint-right').style.opacity = '0';
    document.getElementById('opt-left').className = 'opt';
    document.getElementById('opt-right').className = 'opt';
  } else {
    resetHints();
  }
}

function dragEnd() {
  if (!isDragging) return;
  isDragging = false;
  document.onmousemove = null; document.onmouseup = null;
  document.ontouchmove = null; document.ontouchend = null;

  const THRESHOLD_X = 100;
  const THRESHOLD_Y = 80;

  if (currentX < -THRESHOLD_X) answer('left');
  else if (currentX > THRESHOLD_X) answer('right');
  else if (currentY < -THRESHOLD_Y) answer('skip');
  else {
    // snap back
    card.style.transition = 'transform 0.4s cubic-bezier(0.34,1.56,0.64,1)';
    card.style.transform = '';
    resetHints();
  }
  currentX = 0; currentY = 0;
}

// ========== DRAG & DROP ==========

function launchConfetti() {
  const container = document.getElementById('confetti-container');
  const colors = ['#FFD166','#FF6B35','#2ECC7A','#1A1410','#F5F0E8'];
  for (let i = 0; i < 40; i++) {
    setTimeout(() => {
      const dot = document.createElement('div');
      dot.className = 'confetti-dot';
      dot.style.cssText = `
        left: ${Math.random()*100}%;
        top: -10px;
        background: ${colors[Math.floor(Math.random()*colors.length)]};
        width: ${4+Math.random()*8}px;
        height: ${4+Math.random()*8}px;
        animation-delay: 0s;
        animation-duration: ${0.8+Math.random()*1.2}s;
        border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
      `;
      container.appendChild(dot);
      setTimeout(() => dot.remove(), 2000);
    }, i * 30);
  }
}

function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

// Category selection
document.querySelectorAll('.cat-chip').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
  });
});

// ========== CLICK TO ANSWER ==========

function answerClick(side) {
  const opt = document.getElementById('opt-' + side);
  opt.classList.add(side === 'left' ? 'chosen-left' : 'chosen-right');
  // Small delay so user sees the selection before card flies out
  setTimeout(() => answer(side), 180);
}

// ========== LIKE QUESTION ==========

function likeQuestion() {
  const btn = document.getElementById('like-btn');
  btn.classList.add('liked');
  btn.textContent = 'üëç';
  // Store like in localStorage
  const q = questions[currentIdx];
  if (q) {
    const cat = q._cat || currentCat;
    const idx = q._catIdx !== undefined ? q._catIdx : (QUESTIONS[cat] ? QUESTIONS[cat].indexOf(q) : -1);
    if (idx >= 0) {
      const key = `likes_${cat}_${idx}`;
      localStorage.setItem(key, (parseInt(localStorage.getItem(key) || '0') + 1).toString());
    }
  }
  // Reset after short time
  setTimeout(() => { btn.classList.remove('liked'); }, 1200);
}

// ========== NEW QUESTION MODAL ==========

function openNewQuestionModal() {
  // Set select to current category
  const sel = document.getElementById('new-q-cat');
  if (currentCat !== 'Random' && currentCat !== 'Popular') sel.value = currentCat;
  document.getElementById('new-q-left').value = '';
  document.getElementById('new-q-right').value = '';
  document.getElementById('modal-new-q').classList.add('open');
}

function closeNewQuestionModal(e) {
  if (!e || e.target === document.getElementById('modal-new-q')) {
    document.getElementById('modal-new-q').classList.remove('open');
  }
}

function submitNewQuestion() {
  const cat = document.getElementById('new-q-cat').value;
  const left = document.getElementById('new-q-left').value.trim();
  const right = document.getElementById('new-q-right').value.trim();
  if (!left || !right) { 
    document.getElementById('new-q-left').style.borderColor = left ? '' : 'var(--nomatch)';
    document.getElementById('new-q-right').style.borderColor = right ? '' : 'var(--nomatch)';
    return; 
  }
  const newQ = { l: left, r: right };
  QUESTIONS[cat].push(newQ);
  // Save to localStorage
  try {
    const saved = JSON.parse(localStorage.getItem('custom_questions') || '{}');
    if (!saved[cat]) saved[cat] = [];
    saved[cat].push(newQ);
    localStorage.setItem('custom_questions', JSON.stringify(saved));
  } catch(e) {}
  // Inject as next question, trim from end to keep total at 20
  if (questions.length > 0 && currentIdx < questions.length) {
    questions.splice(currentIdx + 1, 0, newQ);
    if (questions.length > 20) questions.splice(20, questions.length - 20);
  }
  closeNewQuestionModal();
  showToast('Question added ‚Äî comes up next! üéâ');
}

function showToast(msg) {
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.cssText = `position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--ink);color:var(--bg);padding:10px 20px;border-radius:100px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;z-index:400;opacity:0;transition:opacity 0.3s;white-space:nowrap;`;
  document.body.appendChild(t);
  requestAnimationFrame(() => { t.style.opacity = '1'; });
  setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2200);
}

// Strip emojis from a string
function stripEmojis(str) {
  return str.replace(/[\u{1F300}-\u{1F9FF}\u{2600}-\u{27BF}\u{1FA00}-\u{1FAFF}\uFE0F\u200D]/gu, '').trim();
}

// Load custom questions and edits on startup - auto-clears old emoji data from localStorage
(function loadCustomQuestions() {
  try {
    // If localStorage has emoji-containing question data, wipe it - built-in questions are already clean
    ['custom_questions', 'question_edits'].forEach(key => {
      const raw = localStorage.getItem(key);
      if (raw && /[\u{1F300}-\u{1F9FF}\u{2600}-\u{27BF}]/u.test(raw)) {
        localStorage.removeItem(key);
      }
    });

    const saved = JSON.parse(localStorage.getItem('custom_questions') || '{}');
    Object.keys(saved).forEach(cat => {
      if (QUESTIONS[cat]) QUESTIONS[cat].push(...saved[cat]);
    });
    const edits = JSON.parse(localStorage.getItem('question_edits') || '{}');
    Object.keys(edits).forEach(cat => {
      if (QUESTIONS[cat]) {
        Object.keys(edits[cat]).forEach(i => {
          if (QUESTIONS[cat][i]) QUESTIONS[cat][i] = { ...QUESTIONS[cat][i], ...edits[cat][i] };
        });
      }
    });
  } catch(e) {}
})();

// ========== BURGER MENU & DRAWER ==========

let drawerOpen = false;

function toggleDrawer() {
  // If any panel is open, close it and open the drawer
  const openPanels = document.querySelectorAll('.panel-screen.open');
  if (openPanels.length > 0) {
    openPanels.forEach(p => p.classList.remove('open'));
    openDrawer();
    return;
  }
  drawerOpen ? closeDrawer() : openDrawer();
}

function openDrawer() {
  drawerOpen = true;
  document.getElementById('burger-btn').classList.add('open');
  document.getElementById('drawer-overlay').classList.add('open');
  document.getElementById('drawer').classList.add('open');
  // Update matches badge
  const matches = JSON.parse(localStorage.getItem('match_history') || '[]');
  document.getElementById('matches-badge').textContent = matches.length;
}

function closeDrawer() {
  drawerOpen = false;
  document.getElementById('burger-btn').classList.remove('open');
  document.getElementById('drawer-overlay').classList.remove('open');
  document.getElementById('drawer').classList.remove('open');
}

function navTo(page) {
  closeDrawer();
  if (page === 'home') {
    goHome(); return;
  }
  // Update active drawer item
  document.querySelectorAll('.drawer-item').forEach(i => i.classList.remove('active'));
  
  setTimeout(() => {
    if (page === 'matches') openPanel('panel-matches', renderMatches);
    if (page === 'messages') openPanel('panel-messages', renderMessages);
    if (page === 'settings') openPanel('panel-settings');
  }, 200);
}

function openPanel(id, renderFn) {
  document.getElementById(id).classList.add('open');
  if (renderFn) renderFn();
}

function closePanel(id) {
  document.getElementById(id).classList.remove('open');
}

// ========== MATCHES PANEL ==========

// Save match to history after quiz completes
function saveMatchToHistory(match, pct, friendName, matchKey) {
  try {
    const history = JSON.parse(localStorage.getItem('match_history') || '[]');
    history.unshift({
      cat: match.category,
      pct,
      friend: friendName || 'Friend',
      date: new Date().toLocaleDateString(),
      questions: match.questions,
      personA: match.personA,
      personB: match.personB,
      matchKey: matchKey || '',
    });
    localStorage.setItem('match_history', JSON.stringify(history.slice(0, 50)));
  } catch(e) {}
}

// Render matches grouped by person
function renderMatches() {
  const body = document.getElementById('matches-body');
  const history = JSON.parse(localStorage.getItem('match_history') || '[]');
  if (history.length === 0) {
    body.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üéØ</div><div class="empty-state-title">No matches yet</div><div class="empty-state-sub">Complete a quiz and share your link to see your first match here!</div></div>`;
    return;
  }

  // Group by friend name
  const byPerson = {};
  history.forEach((m, i) => {
    const key = m.friend || 'Friend';
    if (!byPerson[key]) byPerson[key] = [];
    byPerson[key].push({ ...m, historyIdx: i });
  });

  body.innerHTML = Object.entries(byPerson).map(([person, matches]) => `
    <div style="margin-bottom:20px;">
      <div style="font-family:'Syne',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);padding:0 4px 8px;">
        ${person}
      </div>
      ${matches.map(m => {
        // Recompute pct from stored answers if available (fixes old wrong values)
        let displayPct = m.pct;
        if (m.personA && m.personB) {
          let ms = 0, t = 0;
          m.personA.forEach((a, i) => {
            const b = m.personB[i];
            if (a !== 'skip' && b !== 'skip') { t++; if (a === b) ms++; }
          });
          displayPct = t > 0 ? Math.round(ms/t*100) : 0;
        }
        return `
        <div class="match-list-item" onclick="openMatchDetail(${m.historyIdx})">
          <div class="match-cat-icon" style="font-family:'Syne',sans-serif;font-size:11px;font-weight:700;">${m.cat}</div>
          <div class="match-info">
            <div class="match-info-title">${m.cat}</div>
            <div class="match-info-sub">${m.date}</div>
          </div>
          <div class="match-pct-badge" style="color:${displayPct>=60?'var(--match)':displayPct>=40?'var(--ink)':'var(--accent)'}">${displayPct}%</div>
          <button onclick="event.stopPropagation();openChatForPerson('${person}')" 
            style="width:32px;height:32px;border-radius:50%;border:1.5px solid rgba(26,20,16,0.2);background:transparent;cursor:pointer;font-size:14px;flex-shrink:0;display:flex;align-items:center;justify-content:center;">üí¨</button>
        </div>`;
      }).join('')}
    </div>
  `).join('');
}

function openMatchDetail(historyIdx) {
  const history = JSON.parse(localStorage.getItem('match_history') || '[]');
  const m = history[historyIdx];
  if (!m || !m.questions) return;
  currentMatchData = { category: m.cat, questions: m.questions, personA: m.personA, personB: m.personB, _fromHistory: true };
  closePanel('panel-matches');
  setTimeout(() => showResultsForBoth(currentMatchData), 300);
}

// ========== MESSAGES PANEL ==========

function renderMessages() {
  const body = document.getElementById('messages-body');
  const convos = JSON.parse(localStorage.getItem('conversations') || '[]');
  if (convos.length === 0) {
    body.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üíå</div><div class="empty-state-title">No messages yet</div><div class="empty-state-sub">Tap üí¨ next to any match result to start chatting!</div></div>`;
    return;
  }
  body.innerHTML = convos.map((c, i) => `
    <div class="msg-list-item" onclick="openChat(${i})">
      <div class="msg-avatar">${c.avatar || 'üòä'}</div>
      <div class="msg-info">
        <div class="msg-name">${c.name}</div>
        <div class="msg-preview">${c.lastMsg || 'Say hi!'}</div>
      </div>
      <div class="msg-time">${c.lastTime || ''}</div>
    </div>
  `).join('');
}

let currentConvoIdx = null;

function getOrCreateConvo(personName, context) {
  const convos = JSON.parse(localStorage.getItem('conversations') || '[]');
  let idx = convos.findIndex(c => c.name === personName);
  // Always update matchPct if we have fresh data
  if (idx >= 0 && context.matchPct !== undefined) {
    convos[idx].matchPct = context.matchPct;
    convos[idx].matchCat = context.matchCat || convos[idx].matchCat;
    localStorage.setItem('conversations', JSON.stringify(convos));
  }
  if (idx < 0) {
    convos.push({ name: personName, avatar: 'üòä', messages: [], lastMsg: '', lastTime: '', ...context });
    idx = convos.length - 1;
    localStorage.setItem('conversations', JSON.stringify(convos));
  }
  return idx;
}

function openChatForPerson(personName) {
  const idx = getOrCreateConvo(personName, {});
  closePanel('panel-matches');
  setTimeout(() => openChat(idx), 300);
}

// Opens chat pre-filled with a question context message
function openChatFromResult(questionIdx) {
  if (!currentMatchData) return;
  const q = currentMatchData.questions[questionIdx];
  if (!q) return;
  const history = JSON.parse(localStorage.getItem('match_history') || '[]');
  const friendName = history[0]?.friend || 'Friend';
  const currentPct = parseInt(document.getElementById('match-pct')?.textContent) || null;
  const idx = getOrCreateConvo(friendName, { matchCat: currentMatchData.category, matchPct: currentPct });
  currentConvoIdx = idx;
  openChat(idx, q);
}

function openChat(idx, prefillQuestion) {
  const convos = JSON.parse(localStorage.getItem('conversations') || '[]');
  const c = convos[idx];
  if (!c) return;
  currentConvoIdx = idx;

  document.getElementById('chat-name').textContent = c.name;
  document.getElementById('chat-avatar').textContent = c.avatar || 'üòä';
  const matchPct = c.matchPct !== undefined && c.matchPct !== null ? c.matchPct : (currentMatchData ? parseInt(document.getElementById('match-pct')?.textContent) || null : null);
  document.getElementById('chat-match-info').textContent = c.matchCat ? (matchPct !== null ? matchPct + '% match ¬∑ ' : '') + c.matchCat : '';

  const msgs = document.getElementById('chat-messages');
  msgs.innerHTML = c.messages.length
    ? c.messages.map(m => `<div class="chat-bubble ${m.from === 'me' ? 'me' : 'them'}">${m.text}</div>`).join('')
    : '<div style="text-align:center;color:var(--muted);font-size:13px;padding:20px;">Say hi! üëã</div>';
  msgs.scrollTop = msgs.scrollHeight;

  // Pre-fill input if coming from a result row
  if (prefillQuestion) {
    document.getElementById('chat-input').value = `${prefillQuestion.l.trim()} or ${prefillQuestion.r.trim()} ‚Äì let's talk about this.`;
  }

  openPanel('panel-chat');
}

function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text || currentConvoIdx === null) return;

  const convos = JSON.parse(localStorage.getItem('conversations') || '[]');
  const now = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  convos[currentConvoIdx].messages.push({ from: 'me', text, time: now });
  convos[currentConvoIdx].lastMsg = text;
  convos[currentConvoIdx].lastTime = now;
  localStorage.setItem('conversations', JSON.stringify(convos));
  input.value = '';

  const msgs = document.getElementById('chat-messages');
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble me';
  bubble.textContent = text;
  if (msgs.querySelector('[style*="Say hi"]')) msgs.innerHTML = '';
  msgs.appendChild(bubble);
  msgs.scrollTop = msgs.scrollHeight;
}

// Hook into showResultsForBoth to save match history and store currentMatchData
const _origShowResults = showResultsForBoth;
window.showResultsForBoth = function(match) {
  currentMatchData = match;
  _origShowResults(match);
  // Only save if this is a new match (not reopened from history)
  if (!match._fromHistory) {
    setTimeout(() => {
      // Compute pct directly from match data (don't rely on animated DOM element)
    const answersA = match.personA || [];
    const answersB = match.personB || [];
    let m = 0, t = 0;
    answersA.forEach((a, i) => {
      const b = answersB[i];
      if (a !== 'skip' && b !== 'skip') { t++; if (a === b) m++; }
    });
    const pct = t > 0 ? Math.round(m/t*100) : 0;
      // Dedup: use encoded questions as unique key
      const matchKey = (match.personA || []).join('') + '_' + (match.personB || []).join('') + '_' + match.category;
      const history = JSON.parse(localStorage.getItem('match_history') || '[]');
      const alreadyExists = history.some(h => h.matchKey === matchKey);
      if (!alreadyExists) {
        const currentUser = getCurrentUser(); saveMatchToHistory(match, pct, currentUser ? currentUser.username : 'Me', matchKey);
      }
      document.getElementById('matches-badge').textContent = 
        JSON.parse(localStorage.getItem('match_history') || '[]').length;
    }, 100);
  }
};
// ========== AUTH ==========

function getUsers() {
  try { return JSON.parse(localStorage.getItem('alike_users') || '{}'); } catch(e) { return {}; }
}
function getCurrentUser() {
  try { return JSON.parse(localStorage.getItem('alike_current_user') || 'null'); } catch(e) { return null; }
}
function setCurrentUser(user) {
  localStorage.setItem('alike_current_user', JSON.stringify(user));
  updateUserBadge();
}

function updateUserBadge() {
  const user = getCurrentUser();
  const badge = document.getElementById('user-badge');
  if (badge) badge.textContent = user ? user.username : '';
}

function showLogin() {
  document.getElementById('auth-register-view').style.display = 'none';
  document.getElementById('auth-login-view').style.display = '';
  document.getElementById('login-error').textContent = '';
}
function showRegister() {
  document.getElementById('auth-login-view').style.display = 'none';
  document.getElementById('auth-register-view').style.display = '';
  document.getElementById('reg-error').textContent = '';
}

function doRegister() {
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim().toLowerCase();
  const password = document.getElementById('reg-password').value;
  const errEl = document.getElementById('reg-error');

  if (!username || username.length < 2) { errEl.textContent = 'Username must be at least 2 characters.'; return; }
  if (!email.includes('@')) { errEl.textContent = 'Please enter a valid e-mail.'; return; }
  if (password.length < 6) { errEl.textContent = 'Password must be at least 6 characters.'; return; }

  const users = getUsers();
  if (users[email]) { errEl.textContent = 'This e-mail is already registered.'; return; }

  users[email] = { username, email, password };
  localStorage.setItem('alike_users', JSON.stringify(users));
  setCurrentUser({ username, email });
  enterApp();
}

function doLogin() {
  const email = document.getElementById('login-email').value.trim().toLowerCase();
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');

  const users = getUsers();
  const user = users[email];
  if (!user) { errEl.textContent = 'No account found for this e-mail.'; return; }
  if (user.password !== password) { errEl.textContent = 'Incorrect password.'; return; }

  setCurrentUser({ username: user.username, email });
  enterApp();
}

function enterApp() {
  document.getElementById('screen-auth').classList.add('hidden');
  updateUserBadge();
}

function checkAuth() {
  const user = getCurrentUser();
  if (user) {
    document.getElementById('screen-auth').classList.add('hidden');
    updateUserBadge();
  }
  // else auth screen stays visible (it's shown by default)
}


function showForgotPassword() {
  ['auth-register-view','auth-login-view','auth-change-pw-view'].forEach(id => document.getElementById(id).style.display = 'none');
  document.getElementById('auth-forgot-view').style.display = '';
  document.getElementById('forgot-error').textContent = '';
  document.getElementById('forgot-result').textContent = '';
}

function doForgotPassword() {
  const email = document.getElementById('forgot-email').value.trim().toLowerCase();
  const users = getUsers();
  const user = users[email];
  if (!user) { document.getElementById('forgot-error').textContent = 'No account found for this e-mail.'; return; }
  document.getElementById('forgot-result').textContent = 'Your password is: ' + user.password;
  document.getElementById('forgot-error').textContent = '';
}

function openChangePassword() {
  closePanel('panel-settings');
  ['auth-register-view','auth-login-view','auth-forgot-view'].forEach(id => document.getElementById(id).style.display = 'none');
  document.getElementById('auth-change-pw-view').style.display = '';
  document.getElementById('change-pw-current').value = '';
  document.getElementById('change-pw-new').value = '';
  document.getElementById('change-pw-error').textContent = '';
  document.getElementById('screen-auth').classList.remove('hidden');
}

function cancelChangePassword() {
  document.getElementById('screen-auth').classList.add('hidden');
}

function doChangePassword() {
  const current = document.getElementById('change-pw-current').value;
  const newPw = document.getElementById('change-pw-new').value;
  const errEl = document.getElementById('change-pw-error');
  const user = getCurrentUser();
  if (!user) return;
  const users = getUsers();
  if (users[user.email].password !== current) { errEl.textContent = 'Current password is incorrect.'; return; }
  if (newPw.length < 6) { errEl.textContent = 'New password must be at least 6 characters.'; return; }
  users[user.email].password = newPw;
  localStorage.setItem('alike_users', JSON.stringify(users));
  document.getElementById('screen-auth').classList.add('hidden');
  showToast('Password updated! ‚úÖ');
}

function openQuestionEditor() {
  closePanel('panel-settings');
  setTimeout(() => {
    renderEditList();
    openPanel('panel-edit-questions');
  }, 300);
}

function renderEditList() {
  const cat = document.getElementById('edit-q-cat').value;
  const qs = QUESTIONS[cat] || [];
  const list = document.getElementById('edit-q-list');
  list.innerHTML = qs.map((q, i) => {
    const lVal = q.l.replace(/"/g, '&quot;');
    const rVal = q.r.replace(/"/g, '&quot;');
    return `<div class="edit-q-item">
      <div class="edit-q-row"><span class="edit-q-label">A</span>
      <input class="edit-q-input" id="eq-${i}-l" value="${lVal}" /></div>
      <div class="edit-q-row"><span class="edit-q-label">B</span>
      <input class="edit-q-input" id="eq-${i}-r" value="${rVal}" /></div>
      <button class="edit-q-save" onclick="saveEditedQuestion('${cat}',${i})">Save</button>
    </div>`;
  }).join('');
}

function saveEditedQuestion(cat, idx) {
  const l = document.getElementById('eq-' + idx + '-l').value.trim();
  const r = document.getElementById('eq-' + idx + '-r').value.trim();
  if (!l || !r) return;
  QUESTIONS[cat][idx] = { ...QUESTIONS[cat][idx], l, r };
  try {
    const edits = JSON.parse(localStorage.getItem('question_edits') || '{}');
    if (!edits[cat]) edits[cat] = {};
    edits[cat][idx] = { l, r };
    localStorage.setItem('question_edits', JSON.stringify(edits));
  } catch(e) {}
  showToast('Saved ‚úÖ');
}

function clearMatchHistory() {
  if (confirm('Clear all match history?')) {
    localStorage.removeItem('match_history');
    localStorage.removeItem('conversations');
    document.getElementById('matches-badge').textContent = '';
    closePanel('panel-settings');
  }
}

function doLogout() {
  if (confirm('Log out of Alike?')) {
    localStorage.removeItem('alike_current_user');
    document.getElementById('screen-auth').classList.remove('hidden');
    showRegister();
    closePanel('panel-settings');
    closeDrawer();
  }
}

</script>
<!-- ‚îÄ‚îÄ BURGER BUTTON ‚îÄ‚îÄ -->
<button class="burger-btn" id="burger-btn" onclick="toggleDrawer()">
  <span></span><span></span><span></span>
</button>

<!-- ‚îÄ‚îÄ DRAWER OVERLAY ‚îÄ‚îÄ -->
<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>

<!-- ‚îÄ‚îÄ DRAWER PANEL ‚îÄ‚îÄ -->
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div class="drawer-logo">
      <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="14" cy="14" r="7" fill="#FFD166"/>
        <circle cx="26" cy="26" r="7" fill="#FF6B35"/>
        <path d="M14 21 C14 21 18 26 26 19" stroke="#FFFDF8" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="drawer-title">Alike</div>
  </div>

  <nav class="drawer-nav">
    <div class="drawer-section-title">Menu</div>

    <div class="drawer-item active" onclick="navTo('home')">
      <div class="drawer-icon">üè†</div>
      <div class="drawer-item-text">
        <div class="drawer-item-label">Home</div>
        <div class="drawer-item-sub">Pick a category & play</div>
      </div>
    </div>

    <div class="drawer-item" onclick="navTo('matches')">
      <div class="drawer-icon">‚úÖ</div>
      <div class="drawer-item-text">
        <div class="drawer-item-label">Matches</div>
        <div class="drawer-item-sub">Your match history</div>
      </div>
      <div class="drawer-badge" id="matches-badge">0</div>
    </div>

    <div class="drawer-item" onclick="navTo('messages')">
      <div class="drawer-icon">üí¨</div>
      <div class="drawer-item-text">
        <div class="drawer-item-label">Messages</div>
        <div class="drawer-item-sub">Chat with your matches</div>
      </div>
      <div class="drawer-badge" id="msg-badge" style="display:none;">2</div>
    </div>

    <div class="drawer-section-title" style="margin-top:8px;">More</div>

    <div class="drawer-item" onclick="navTo('settings')">
      <div class="drawer-icon">‚öôÔ∏è</div>
      <div class="drawer-item-text">
        <div class="drawer-item-label">Settings</div>
        <div class="drawer-item-sub">Notifications, account‚Ä¶</div>
      </div>
    </div>
  </nav>

  <div class="drawer-footer">Alike ¬∑ Built with ‚ù§Ô∏è</div>
</div>

<!-- ‚îÄ‚îÄ MATCHES PANEL ‚îÄ‚îÄ -->
<div class="panel-screen" id="panel-matches">
  <div class="panel-header">
    <button class="panel-back" onclick="closePanel('panel-matches')">‚Üê</button>
    <div class="panel-title">‚úÖ Matches</div>
  </div>
  <div class="panel-body" id="matches-body">
    <div class="empty-state">
      <div class="empty-state-icon">üéØ</div>
      <div class="empty-state-title">No matches yet</div>
      <div class="empty-state-sub">Complete a quiz and share your link with a friend to see your first match here!</div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ MESSAGES PANEL ‚îÄ‚îÄ -->
<div class="panel-screen" id="panel-messages">
  <div class="panel-header">
    <button class="panel-back" onclick="closePanel('panel-messages')">‚Üê</button>
    <div class="panel-title">üí¨ Messages</div>
  </div>
  <div class="panel-body" id="messages-body">
    <div class="empty-state">
      <div class="empty-state-icon">üíå</div>
      <div class="empty-state-title">No messages yet</div>
      <div class="empty-state-sub">After matching with a friend, you can start a conversation here!</div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ CHAT PANEL ‚îÄ‚îÄ -->
<div class="panel-screen" id="panel-chat" style="display:flex; flex-direction:column;">
  <div class="chat-header">
    <button class="panel-back" onclick="closePanel('panel-chat')">‚Üê</button>
    <div class="msg-avatar" id="chat-avatar">üòä</div>
    <div style="flex:1;">
      <div class="panel-title" id="chat-name" style="font-size:17px;">Friend</div>
      <div style="font-size:11px; color:var(--muted);" id="chat-match-info">‚Äî % match</div>
    </div>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-bar">
    <input class="chat-input" id="chat-input" placeholder="Say something..." onkeydown="if(event.key==='Enter') sendMessage()">
    <button class="chat-send" onclick="sendMessage()">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
        <path d="M9 15V3M9 3L4 8M9 3L14 8" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
</div>

<!-- ‚îÄ‚îÄ SETTINGS PANEL ‚îÄ‚îÄ -->
<div class="panel-screen" id="panel-settings">
  <div class="panel-header">
    <button class="panel-back" onclick="closePanel('panel-settings')">‚Üê</button>
    <div class="panel-title">‚öôÔ∏è Settings</div>
  </div>
  <div class="panel-body">
    <div class="settings-section">
      <div class="settings-item">
        <div class="settings-item-icon">üîî</div>
        <div class="settings-item-label">Notifications</div>
        <button class="settings-toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
      <div class="settings-item">
        <div class="settings-item-icon">üåô</div>
        <div class="settings-item-label">Dark Mode</div>
        <button class="settings-toggle" onclick="this.classList.toggle('on')"></button>
      </div>
      <div class="settings-item">
        <div class="settings-item-icon">üîä</div>
        <div class="settings-item-label">Sound Effects</div>
        <button class="settings-toggle on" onclick="this.classList.toggle('on')"></button>
      </div>

    </div>
    <div class="settings-section">
      <div class="settings-item">
        <div class="settings-item-icon">üë§</div>
        <div class="settings-item-label">Display Name</div>
        <div class="settings-item-value" id="settings-username">You</div>
      </div>
      <div class="settings-item" style="cursor:pointer;" onclick="openQuestionEditor()">
        <div class="settings-item-icon">‚úèÔ∏è</div>
        <div class="settings-item-label">Edit Questions</div>
        <div class="settings-item-value">‚Üí</div>
      </div>
      <div class="settings-item" style="cursor:pointer;" onclick="openChangePassword()">
        <div class="settings-item-icon">üîë</div>
        <div class="settings-item-label">Change Password</div>
        <div class="settings-item-value">‚Üí</div>
      </div>
      <div class="settings-item">
        <div class="settings-item-icon">üö™</div>
        <div class="settings-item-label">Log out</div>
        <div class="settings-item-value" style="color:var(--nomatch);cursor:pointer;" onclick="doLogout()">‚Üí</div>
      </div>
      <div class="settings-item">
        <div class="settings-item-icon">üóëÔ∏è</div>
        <div class="settings-item-label">Clear Match History</div>
        <div class="settings-item-value" style="color:var(--nomatch);cursor:pointer;" onclick="clearMatchHistory()">Clear</div>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-item">
        <div class="settings-item-icon">‚≠ê</div>
        <div class="settings-item-label">Rate Alike</div>
        <div class="settings-item-value">‚Üí</div>
      </div>
      <div class="settings-item">
        <div class="settings-item-icon">üì®</div>
        <div class="settings-item-label">Send Feedback</div>
        <div class="settings-item-value">‚Üí</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ QUESTION EDITOR PANEL ‚îÄ‚îÄ -->
<div class="panel-screen" id="panel-edit-questions">
  <div class="panel-header">
    <button class="panel-back" onclick="closePanel('panel-edit-questions')">‚Üê</button>
    <div class="panel-title">‚úèÔ∏è Edit Questions</div>
  </div>
  <div class="panel-body">
    <div style="margin-bottom:12px;">
      <select class="modal-cat-select" id="edit-q-cat" onchange="renderEditList()" style="width:100%;padding:10px 12px;border-radius:12px;border:2px solid rgba(26,20,16,0.2);font-family:'DM Sans',sans-serif;font-size:14px;background:var(--card);">
        <option value="Lifestyle">‚ú® Lifestyle</option>
        <option value="Food">üçï Food</option>
        <option value="Love">üíò Love</option>
        <option value="Music">üéµ Music</option>
        <option value="Travel">‚úàÔ∏è Travel</option>
        <option value="Culture">üé≠ Culture</option>
        <option value="Sports">‚öΩ Sports</option>
        <option value="Values">üß≠ Values</option>
        <option value="People">ü§ù People</option>
        <option value="Future">üöÄ Future</option>
      </select>
    </div>
    <div id="edit-q-list" style="display:flex;flex-direction:column;gap:10px;"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ NEW QUESTION MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="modal-new-q" onclick="closeNewQuestionModal(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">‚ûï Suggest a question</div>
    <select class="modal-cat-select" id="new-q-cat">
      <option value="Lifestyle">‚ú® Lifestyle</option>
      <option value="Food">üçï Food</option>
      <option value="Love">üíò Love</option>
      <option value="Music">üéµ Music</option>
      <option value="Travel">‚úàÔ∏è Travel</option>
      <option value="Culture">üé≠ Culture</option>
      <option value="Sports">‚öΩ Sports</option>
      <option value="Values">üß≠ Values</option>
      <option value="People">ü§ù People</option>
      <option value="Future">üöÄ Future</option>
    </select>
    <div class="modal-inputs-row">
      <input class="modal-input" id="new-q-left" placeholder="üÖ∞Ô∏è Option A" maxlength="30">
      <input class="modal-input" id="new-q-right" placeholder="üÖ±Ô∏è Option B" maxlength="30">
    </div>
    <button class="btn-primary" style="width:100%;" onclick="submitNewQuestion()">Add Question ‚úì</button>
  </div>
</div>

</body>
</html>
